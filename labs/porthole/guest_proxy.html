<html>
<head>
  <title></title>
</head>
<body>

  <h3>Guest</h3>

  <script type="text/javascript">
    window.postMessage = null;
  </script>
  <script src="porthole.js"></script>

  <script type="text/javascript">
    window.onload=function(){

      var hash = decodeURIComponent(location.hash.substr(0)),
          m = hash.match(/PARENT=(.*)/),
          parentProxy =  m && m[1],
          type = !parentProxy ? 'relay' : 'child';

      console.log(type, location.origin, parentProxy);

      if(type === 'relay') {
        Porthole.WindowProxyDispatcher.start();
        return;
      }

      // Create a proxy window to send to and receive 
      // messages from the iFrame
      var windowProxy = new Porthole.WindowProxy(parentProxy);

      // Register an event handler to receive messages;
      windowProxy.addEventListener(function(e) {

        //e.data, 

        console.log(e.origin, '=>', location.origin, 
          '(', e.data.length, ')');


        if(e.data === 'ping')
          windowProxy.post('pong');

      });

      var id = (Math.random()*Math.pow(2,32)).toString(16);
      window['windowProxy'+id] = windowProxy;

    };
  </script>

</body>
</html>