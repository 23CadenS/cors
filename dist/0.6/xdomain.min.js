// XDomain - v0.6.8 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2014
(function(a,b){!function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=[].slice;p=a.document,d="before",c="after",k="readyState",j="addEventListener",i="removeEventListener",g="dispatchEvent",n="XMLHttpRequest",h="FormData",l=["load","loadend","loadstart"],e=["progress","abort","error","timeout"],(v=Array.prototype).indexOf||(v.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),t=function(a,b){return Array.prototype.slice.call(a,b)},r=function(a,b){var c,d;for(c in a)if(d=a[c],"returnValue"!==c)try{b[c]=a[c]}catch(e){}return b},s=function(a,b,c){var d,e,f,h;for(e=function(a){return function(d){var e,f,h;e={};for(f in d)"returnValue"!==f&&(h=d[f],e[f]=h===b?c:h);return c[g](a,e)}},f=0,h=a.length;h>f;f++)d=a[f],b["on"+d]=e(d)},q=function(a){var b;if(null!=p.createEventObject)return b=p.createEventObject(),b.type=a,b;try{return new Event(a)}catch(c){return{type:a}}},f=function(a){var c,d,e;return d={},e=function(a){return d[a]||[]},c={},c[j]=function(a,c,f){d[a]=e(a),d[a].indexOf(c)>=0||(f=f===b?d[a].length:f,d[a].splice(f,0,c))},c[i]=function(a,b){var c;c=e(a).indexOf(b),-1!==c&&e(a).splice(c,1)},c[g]=function(){var d,f,g,h,i,j,k,l;for(d=t(arguments),f=d.shift(),a||(d[0]=r(d[0],q(f))),h=c["on"+f],h&&h.apply(b,d),l=e(f).concat(e("*")),g=j=0,k=l.length;k>j;g=++j)i=l[g],i.apply(b,d)},a&&(c.listeners=function(a){return t(e(a))},c.on=c[j],c.off=c[i],c.fire=c[g],c.once=function(a,b){var d;return d=function(){return c.off(a,d),b.apply(null,arguments)},c.on(a,d)},c.destroy=function(){return d={}}),c},u=f(!0),u.EventEmitter=f,u[d]=function(a,b){if(a.length<1||a.length>2)throw"invalid hook";return u[j](d,a,b)},u[c]=function(a,b){if(a.length<2||a.length>3)throw"invalid hook";return u[j](c,a,b)},u.addWithCredentials=!0,u.enable=function(){a[n]=m},u.disable=function(){a[n]=u[n]},o=u.headers=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},u[h]=a[h],a[h]=function(){var a=this;this.fd=new u[h],this.entries=[],this.append=function(){var b;return b=1<=arguments.length?w.call(arguments,0):[],a.entries.push(b),a.fd.append.apply(a.fd,b)}},u[n]=a[n],m=a[n]=function(){var b,i,m,p,q,t,v,w,x,y,z;return z=new u[n],w=!1,q={},q.headers={},t={},t.headers={},p=function(){var a,b,c;t.status=z.status,t.statusText=z.statusText,c=o(z.getAllResponseHeaders());for(a in c)b=c[a],t.headers[a]||(t.headers[a]=b)},m=function(){try{t.text=z.responseText}catch(a){}try{t.xml=z.responseXML}catch(a){}t.data=z.response||t.text},y=function(){i.status=t.status,i.statusText=t.statusText},x=function(){t.hasOwnProperty("text")?i.responseText=t.text:t.hasOwnProperty("xml")?i.responseXML=t.xml:i.response=t.data||null},b=0,v=function(a){var d,e,f;return d=function(){for(;a>b&&4>b;)i[k]=++b,1===b&&i[g]("loadstart",{}),2===b&&y(),4===b&&(y(),x()),i[g]("readystatechange",{}),4===b&&(i[g]("load",{}),i[g]("loadend",{}))},4>a?(d(),void 0):(e=u.listeners(c),f=function(){var a;return e.length?(a=e.shift(),2===a.length?(a(q,t),f()):3===a.length?a(q,t,f):void 0):d()},f(),void 0)},z.onreadystatechange=function(){try{2===z[k]&&p()}catch(a){}4===z[k]&&(w=!1,p(),m()),v(z[k])},i=q.xhr=f(),i[j]("progress",function(){return v(3)}),s(e,z,i),u.addWithCredentials&&(i.withCredentials=!1),i.status=0,i.open=function(a,b,c,d,e){if(q.method=a,q.url=b,c===!1)throw"sync xhr not supported by XHook";q.user=d,q.pass=e,v(1)},i.send=function(b){var c,e,f,g,j,k,l,m;for(m=["type","timeout","withCredentials"],k=0,l=m.length;l>k;k++)e=m[k],f="type"===e?"responseType":e,f in i&&(q[e]=i[f]);q.body=b,j=function(){var b,c,d,g,i,j;for(w=!0,z.open(q.method,q.url,!0,q.user,q.pass),i=["type","timeout","withCredentials"],d=0,g=i.length;g>d;d++)e=i[d],f="type"===e?"responseType":e,e in q&&(z[f]=q[e]);j=q.headers;for(b in j)c=j[b],z.setRequestHeader(b,c);q.body instanceof a[h]&&(q.body=q.body.fd),z.send(q.body)},c=u.listeners(d),g=function(){var a,b;return c.length?(a=function(a){return"object"!=typeof a||"number"!=typeof a.status&&"number"!=typeof t.status?(g(),void 0):(r(a,t),v(4),void 0)},a.head=function(a){return r(a,t),v(2)},a.progress=function(a){return r(a,t),v(3)},b=c.shift(),1===b.length?a(b(q)):2===b.length?b(q,a):void 0):j()},g()},i.abort=function(){w&&z.abort(),i[g]("abort",{})},i.setRequestHeader=function(a,b){q.headers[a]=b},i.getResponseHeader=function(a){return t.headers[a]},i.getAllResponseHeaders=function(){return o(t.headers)},z.overrideMimeType&&(i.overrideMimeType=function(){return z.overrideMimeType.apply(z,arguments)}),z.upload&&(i.upload=q.upload=f(),s(e.concat(l),z.upload,i.upload)),i},(this.define||Object)((this.exports||this).xhook=u)}(this);var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O;E=null,g=function(a){var b,c;null===E&&(E={},s());for(b in a)c=a[b],y("adding slave: "+b),E[b]=c},o={},p=function(a,b){var c;return o[a]?o[a]:(c=m.createElement("iframe"),c.id=c.name=q(),y("creating iframe "+c.id),c.src=""+a+b,c.setAttribute("style","display:none;"),m.body.appendChild(c),o[a]=c.contentWindow)},s=function(){return xhook.before(function(a,b){var c,d,e,f,g,i;return f=C(a.url),f&&f.origin!==l?E[f.origin]?(y("proxying request to slave: '"+f.origin+"'"),a.async===!1?(K("sync not supported"),b()):(d=p(f.origin,E[f.origin]),i=h(d),i.on("response",function(a){return b(a),i.close()}),a.xhr.addEventListener("abort",function(){return i.emit("abort")}),i.on("xhr-event",function(){return a.xhr.dispatchEvent.apply(null,arguments)}),i.on("xhr-upload-event",function(){return a.xhr.upload.dispatchEvent.apply(null,arguments)}),e=I(a),e.headers=a.headers,g=function(){return i.emit("request",e)},a.withCredentials&&(e.credentials=m.cookie),u(a.body,"Uint8Array")?e.body=a.body:u(a.body,"FormData")&&(c=a.body.entries,e.body=["XD_FD",c]),g(),void 0)):(f&&y("no slave matching: '"+f.origin+"'"),b()):b()})},A=null,f=function(a){var b,c;null===A&&(A={},t());for(b in a)c=a[b],y("adding master: "+b),A[b]=c},t=function(){return w(function(a,b){var c,d,e,f;"null"===a&&(a="*"),e=null;for(c in A){f=A[c];try{if(d=J(c),d.test(a)){e=J(f);break}}catch(g){}}return e?(b.once("request",function(a){var c,d,f,g,h,i,j,k,l,m;if(y("request: "+a.method+" "+a.url),g=C(a.url),!g||!e.test(g.path))return K("blocked request to path: '"+g.path+"' by regex: "+e),b.close(),void 0;i=new XMLHttpRequest,i.open(a.method,a.url),i.addEventListener("*",function(a){return b.emit("xhr-event",a.type,I(a))}),i.upload&&i.upload.addEventListener("*",function(a){return b.emit("xhr-upload-event",a.type,I(a))}),b.once("abort",function(){return i.abort()}),i.onreadystatechange=function(){var a;if(4===i.readyState){a={status:i.status,statusText:i.statusText,data:i.response,headers:xhook.headers(i.getAllResponseHeaders())};try{a.text=i.responseText}catch(c){}return b.emit("response",a)}},a.withCredentials&&(a.headers["XDomain-Cookie"]=a.credentials),a.timeout&&(i.timeout=a.timeout),a.type&&(i.responseType=a.type),l=a.headers;for(f in l)h=l[f],i.setRequestHeader(f,h);if(a.body instanceof Array&&"XD_FD"===a.body[0]){for(d=new xhook.FormData,m=a.body[1],j=0,k=m.length;k>j;j++)c=m[j],d.append.apply(d,c);a.body=d}i.send(a.body||null)}),y("slave listening for requests on socket: "+b.id),void 0):(K("blocked request from: '"+a+"'"),void 0)}),a===a.parent?K("slaves must be in an iframe"):a.parent.postMessage("XDPING_"+d,"*")},B=function(b){return m.addEventListener?a.addEventListener("message",b):a.attachEvent("onmessage",b)},e="XD_CHECK",r=null,G={},v=!0,j=!0,D=function(){},H=function(){return B(function(a){var c,e,f,g;if(c=a.data,D&&(D(a.source),D=null),"string"==typeof c){if(/^XDPING(_(V\d+))?$/.test(c)&&RegExp.$2!==d)return K("your master is not compatible with your slave, check your xdomain.js version");if(/^xdomain-/.test(c))c=c.split(",");else if(v)try{c=JSON.parse(c)}catch(h){return}}if(c instanceof Array&&(f=c.shift(),/^xdomain-/.test(f)&&(g=G[f],null!==g))){if(g===b){if(!r)return;g=k(f,a.source),r(a.origin,g)}e="string"==typeof c[1]?": '"+c[1]+"'":"",y("receive socket: "+f+": '"+c[0]+"'"+e),g.fire.apply(g,c)}})},k=function(a,b){var d,f,g,h,i,j;return i=!1,j=G[a]=xhook.EventEmitter(!0),j.id=a,j.once("close",function(){return j.destroy(),j.close()}),h=[],j.emit=function(){var b,c;b=F(arguments),c="string"==typeof b[1]?": '"+b[1]+"'":"",y("send socket: "+a+": "+b[0]+c),b.unshift(a),i?g(b):h.push(b)},g=function(a){v&&(a=JSON.stringify(a)),b.postMessage(a,"*")},j.close=function(){j.emit("close"),y("close socket: "+a),G[a]=null},j.once(e,function(b){for(v="string"==typeof b,i=!0,y("ready socket: "+a);h.length;)g(h.shift())}),f=0,d=function(){b.postMessage([a,e,{}],"*"),i||(f++===L.timeout/c?K("Timeout waiting on iframe socket"):setTimeout(d,c))},setTimeout(d),y("new socket: "+a),j},h=function(a){var b;return b=k(q(),a)},w=function(a){r=a},L=function(a){a&&(a.masters&&f(a.masters),a.slaves&&g(a.slaves))},L.masters=f,L.slaves=g,L.debug=!1,L.timeout=15e3,c=100,m=a.document,x=a.location,l=L.origin=x.protocol+"//"+x.host,q=function(){return"xdomain-"+Math.round(Math.random()*Math.pow(2,32)).toString(16)},F=function(a,b){return Array.prototype.slice.call(a,b)},i=a.console||{},z=function(a){return function(b){b="xdomain ("+l+"): "+b,a in L&&L[a](b),("log"!==a||L.debug)&&(a in i?i[a](b):"warn"===a&&alert(b))}},y=z("log"),K=z("warn"),O=["postMessage","JSON"];for(M=0,N=O.length;N>M;M++)if(n=O[M],!a[n])return K("requires '"+n+"' and this browser does not support it"),void 0;u=function(b,c){return"function"!=typeof a[c]?!1:b instanceof a[c]},d="V1",C=L.parseUrl=function(a){return/^((https?:)?\/\/[^\/\?]+)(\/.*)?/.test(a)?{origin:(RegExp.$2?"":x.protocol)+RegExp.$1,path:RegExp.$3}:(y("failed to parse absolute url: "+a),null)},J=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".*"),new RegExp("^"+b+"$"))},I=function(a){var b,c,d,e;b={};for(c in a)"returnValue"!==c&&(d=a[c],"function"!=(e=typeof d)&&"object"!==e&&(b[c]=d));return b},function(){var a,b,c,d,e,h,i,j,k,l,n;for(a={debug:function(a){return"string"==typeof a?L.debug="false"!==a:void 0},slave:function(a){var b,c;if(a&&(b=C(a)))return c={},c[b.origin]=b.path,g(c)},master:function(a){var b,c;if(a&&(c="*"===a?{origin:"*",path:"*"}:C(a)))return b={},b[c.origin]=c.path.replace(/^\//,"")?c.path:"*",f(b)}},l=m.getElementsByTagName("script"),h=0,j=l.length;j>h;h++)if(e=l[h],/xdomain/.test(e.src))for(n=["","data-"],i=0,k=n.length;k>i;i++){d=n[i];for(c in a)b=a[c],b(e.getAttribute(d+c))}}(),H(),(this.define||Object)((this.exports||this).xdomain=L)}).call(this,window);