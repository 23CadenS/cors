// XDomain - v0.6.0 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2014
!function(a){!function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;n=a.document,d="before",c="after",j="readyState",i="addEventListener",h="removeEventListener",g="dispatchEvent",l="XMLHttpRequest",k=["load","loadend","loadstart"],e=["progress","abort","error","timeout"],(s=Array.prototype).indexOf||(s.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),p=function(a,b){var c,d;for(c in a){d=a[c];try{b[c]=d}catch(e){}}},q=function(a,b,c){var d,e,f,h;for(e=function(a){return function(d){var e,f,h;e={};for(f in d)h=d[f],e[f]=h===b?c:h;return c[g](a,e)}},f=0,h=a.length;h>f;f++)d=a[f],b["on"+d]=e(d)},o=function(a){var b;if(null!=n.createEventObject)return b=n.createEventObject(),b.type=a,b;try{return new Event(a)}catch(c){return{type:a}}},f=function(a){var c,d,e;return d={},e=function(a){return d[a]||[]},c={},c[i]=function(a,c,f){d[a]=e(a),d[a].indexOf(c)>=0||(f=f===b?d[a].length:f,d[a].splice(f,0,c))},c[h]=function(a,b){var c;c=e(a).indexOf(b),-1!==c&&e(a).splice(c,1)},c[g]=function(a,b){var d,f,g,h,i,j,k;for(d=o(a),p(b,d),g=c["on"+a],g&&g(d),k=e(a),f=i=0,j=k.length;j>i;f=++i)h=k[f],h(d)},a&&(c.listeners=function(a){return Array.prototype.slice.call(e(a))},c.on=c[i],c.off=c[h],c.fire=c[g]),c},r=f(!0),r.EventEmitter=f,r[d]=function(a,b){if(a.length<1||a.length>2)throw"invalid hook";return r[i](d,a,b)},r[c]=function(a,b){if(a.length<2||a.length>3)throw"invalid hook";return r[i](c,a,b)},m=r.headers=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},r[l]=a[l],a[l]=function(){var a,b,h,n,s,t,u,v,w,x,y;return y=new r[l],v=!1,s=f(!0),s.headers={},t={},t.headers={},n=function(){var a,b,c;t.status=y.status,t.statusText=y.statusText,c=m(y.getAllResponseHeaders());for(a in c)b=c[a],t.headers[a]||(t.headers[a]=b)},h=function(){try{t.text=y.responseText}catch(a){}try{t.xml=y.responseXML}catch(a){}t.data=y.response||t.text},x=function(){b.status=t.status,b.statusText=t.statusText},w=function(){b.response=t.data||t.text||null,b.responseText=t.text||"",b.responseXML=t.xml||null},a=0,u=function(d){var e,f,h;return e=function(){for(;d>a&&4>a;)b[j]=++a,1===a&&b[g]("loadstart",o("loadstart")),2===a&&x(),4===a&&(x(),w()),b[g]("readystatechange",o("readystatechange")),4===a&&(b[g]("load",o("load")),b[g]("loadend",o("loadend")))},4>d?(e(),void 0):(f=r.listeners(c),h=function(){var a;return f.length?(a=f.shift(),2===a.length?(a(s,t),h()):3===a.length?a(s,t,h):void 0):e()},h(),void 0)},y.onreadystatechange=function(){try{2===y[j]&&n()}catch(a){}4===y[j]&&(v=!1,n(),h()),u(y[j])},b=f(),b[i]("progress",function(){return u(3)}),q(e,y,b),s.on=function(a,c){b[i](a,c)},s.fire=function(a,c){b[g](a,c)},b.withCredentials=!1,b.response=null,b.status=0,b.open=function(a,b,c,d,e){if(s.method=a,s.url=b,c===!1)throw"sync xhr not supported by XHook";s.user=d,s.pass=e,u(1)},b.send=function(a){var c,e,f;s.body=a,f=function(){var a,c,d,e,f,g,h,i;for(v=!0,y.open(s.method,s.url,!0,s.user,s.pass),h=["type","timeout"],f=0,g=h.length;g>f;f++)c=h[f],d="type"===c?"responseType":c,y[d]=s[c]||b[d];i=s.headers;for(a in i)e=i[a],y.setRequestHeader(a,e);y.send(s.body)},c=r.listeners(d),e=function(){var a,b;return c.length?(a=function(a){return"object"!=typeof a||"number"!=typeof a.status&&"number"!=typeof t.status?(e(),void 0):(p(a,t),u(4),void 0)},a.head=function(a){return p(a,t),u(2)},a.text=function(a){return t.text=a,u(3)},b=c.shift(),1===b.length?a(b(s)):2===b.length?b(s,a):void 0):f()},e()},b.abort=function(){v&&y.abort(),b[g]("abort",arguments)},b.setRequestHeader=function(a,b){s.headers[a]=b},b.getResponseHeader=function(a){return t.headers[a]},b.getAllResponseHeaders=function(){return m(t.headers)},y.overrideMimeType&&(b.overrideMimeType=function(){return y.overrideMimeType.apply(y,arguments)}),b.upload=s.upload=f(),y.upload&&q(e.concat(k),y.upload,b.upload),b},(this.define||Object)((this.exports||this).xhook=r)}(this);var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U=[].slice;x=function(b){return document.addEventListener?a.addEventListener("message",b):a.attachEvent("onmessage",b)},w=function(b){return document.removeEventListener?a.removeEventListener("message",b):a.dettachEvent("onmessage",b)},E=null,H={},d=!0,e={XD_OBJ:!0},x(function(a){var b,c,f;switch(b=a.data,typeof b){case"string":try{b=JSON.parse(b)}catch(g){return}break;case"object":if(d&&a.source.postMessage(e,"*"),d=!1,b.XD_OBJ)return}if(b instanceof Array&&(c=b.shift(),/^xdomain-/.test(c))){if(f=H[c],!f){if(!E)return;f=E.handle(c,a.source)}return f.fire.apply(f,b),{readyCheck:function(a){return ready?a():(waiters.push(a),1===waiters.length&&check(),void 0)}}}}),k=function(a,c){var f,g,h,i,j;return j=0,h=!1,g=[],i=H[a]=xhook.EventEmitter(!0),f=function(){if(c.postMessage(e),j++>=K.timeout/b)throw"Timeout waiting on iframe socket";return setTimeout(f,b)},f(),i.once("xd_ready",function(){return i.destroy(),i.close()}),i.once("close",function(){return i.destroy(),i.close()}),i.emit=function(){var b;return b=G(arguments),b.unshift(a),d&&(b=JSON.stringify(b)),c.postMessage(b,"*")},i.close=function(){return delete H[a]},i},i=function(a){var b;return b=new Socket(p(),a)},s=function(a){E=function(b,c){var d;return d=new Socket(c,b.source),a(b,d),d}},F=null,g=function(a){var b,c;null===F&&(F={},q());for(b in a)c=a[b],F[b]=c},n={},o=function(a,b){var c;return n[a]?n[a]:(c=document.createElement("iframe"),c.id=c.name="xdomain-"+p(),c.src=a+b,c.setAttribute("style","display:none;"),document.body.appendChild(c),n[a]=c.contentWindow)},q=function(){return xhook.before(function(a,b){var c,d,e;return e=z(a.url),e&&F[e.origin]?(t("proxying request slave: '"+e.origin+"'"),a.async===!1?(J("sync not supported"),b()):(d=o(e.origin,F[e.origin]),c=i(d),c.on("response",function(a){return b(a),c.close()}),a.on("abort",function(){return c.emit("abort")}),c.on("abort",function(){return c.close()}),c.on("xhr-event",function(b){return a.fire.apply(null,b)}),c.emit("request",a),void 0)):(t("no slave matching: '"+e.origin+"'"),b())})},v=null,f=function(a){var b,c;null===v&&(v={},r());for(b in a)c=a[b],v[b]=c},r=function(){var b,d;return d={},b=function(){},x(function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;i="null"===a.origin?"*":a.origin,k=null;for(f in v){m=v[f];try{if(g=I(f),g.test(i)){k=I(m);break}}catch(q){}}if(!k)return J("blocked request from: '"+i+"'"),void 0;if(c=a.source,o=getMessage(a.data),d=o.id,h=o.msg,j=z(req.url),!j||!k.test(j.path))return J("blocked request to path: '"+j.path+"' by regex: "+m),void 0;b=function(){var a,b;return b=arguments[0],a=2<=arguments.length?U.call(arguments,1):[],c.postMessage(setMessage([d,b].concat(a)),i)},l=new XMLHttpRequest,l.open(req.method,req.url),l.onprogress=function(a){return b("download",{loaded:a.loaded,total:a.total})},l.upload.onprogress=function(a){return b("upload",{loaded:a.loaded,total:a.total})},l.onabort=function(){return b("abort")},l.onreadystatechange=function(){var a;if(4===l.readyState)return a={status:l.status,statusText:l.statusText,text:l.responseText,headers:xhook.headers(l.getAllResponseHeaders())},b("response",a)},req.timeout&&(l.timeout=req.timeout),p=req.headers;for(e in p)n=p[e],l.setRequestHeader(e,n);return l.send(req.body||null)}),a===a.parent?J("slaves must be in an iframe"):a.parent.postMessage("XDPING_"+c,"*")},l=location.protocol+"//"+location.host,p=function(){return(Math.random()*Math.pow(2,32)).toString(16)},G=function(a,b){return Array.prototype.slice.call(a,b)},B=function(a){return"xdomain ("+l+"): "+a},j=a.console||{},t=function(a){K.debug&&(a=B(a),"log"in j&&j.log(a))},J=function(a){a=B(a),"warn"in j?j.warn(a):alert(a)},R=["postMessage","JSON"];for(L=0,O=R.length;O>L;L++)if(m=R[L],!a[m])return J("requires '"+m+"' and this browser does not support it"),void 0;for(c="V0",z=function(a){return/(https?:\/\/[^\/\?]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:(t("failed to parse url: "+a),null)},I=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".+"),new RegExp("^"+b+"$"))},K=function(a){a&&(a.masters&&f(a.masters),a.slaves&&g(a.slaves))},K.debug=!1,K.masters=f,K.slaves=g,K.parseUrl=z,K.origin=l,K.timeout=15e3,b=100,a.xdomain=K,S=document.getElementsByTagName("script"),M=0,P=S.length;P>M;M++)if(D=S[M],/xdomain/.test(D.src))for(T=["","data-"],N=0,Q=T.length;Q>N;N++){if(A=T[N],h=D.getAttribute(A+"slave")){if(y=z(h),!y)return;C={},C[y.origin]=y.path,g(C);break}h=D.getAttribute(A+"master"),h&&(u={},u[h]=/./,f(u))}}(this);