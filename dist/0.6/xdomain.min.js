// XDomain - v0.6.0 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2014
!function(a,b){!function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,b,o,p,q,r,s;b=a.document,e="before",d="after",k="readyState",j="addEventListener",i="removeEventListener",h="dispatchEvent",m="XMLHttpRequest",l=["load","loadend","loadstart"],f=["progress","abort","error","timeout"],(s=Array.prototype).indexOf||(s.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),p=function(a,b){var c,d;for(c in a){d=a[c];try{b[c]=d}catch(e){}}},q=function(a,b,c){var d,e,f,g;for(e=function(a){return function(d){var e,f,g;e={};for(f in d)g=d[f],e[f]=g===b?c:g;return c[h](a,e)}},f=0,g=a.length;g>f;f++)d=a[f],b["on"+d]=e(d)},o=function(a){var c;if(null!=b.createEventObject)return c=b.createEventObject(),c.type=a,c;try{return new Event(a)}catch(d){return{type:a}}},g=function(a){var b,d,e;return d={},e=function(a){return d[a]||[]},b={},b[j]=function(a,b,f){d[a]=e(a),d[a].indexOf(b)>=0||(f=f===c?d[a].length:f,d[a].splice(f,0,b))},b[i]=function(a,b){var c;c=e(a).indexOf(b),-1!==c&&e(a).splice(c,1)},b[h]=function(a,c){var d,f,g,h,i,j,k;for(d=o(a),p(c,d),g=b["on"+a],g&&g(d),k=e(a),f=i=0,j=k.length;j>i;f=++i)h=k[f],h(d)},a&&(b.listeners=function(a){return Array.prototype.slice.call(e(a))},b.on=b[j],b.off=b[i],b.fire=b[h]),b},r=g(!0),r[e]=function(a,b){if(a.length<1||a.length>2)throw"!";return r[j](e,a,b)},r[d]=function(a,b){if(a.length<2||a.length>3)throw"!";return r[j](d,a,b)},n=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},r.headers=n,r[m]=a[m],a[m]=function(){var a,b,c,i,s,t,u,v,w,x,y;return y=new r[m],v=!1,s=g(!0),s.headers={},t={},t.headers={},i=function(){var a,b,c;t.status=y.status,t.statusText=y.statusText,c=n(y.getAllResponseHeaders());for(a in c)b=c[a],t.headers[a]||(t.headers[a]=b)},c=function(){t.type=y.responseType,t.type&&"document"!==t.type||(t.text=y.responseText,t.xml=y.responseXML),t.data=y.response||t.text},x=function(){b.status=t.status,b.statusText=t.statusText},w=function(){b.responseType=t.type||"",b.response=t.data||t.text||null,b.responseText=t.text||"",b.responseXML=t.xml||null},a=0,u=function(c){var e,f,g;return e=function(){for(;c>a&&4>a;)b[k]=++a,1===a&&b[h]("loadstart",o("loadstart")),2===a&&x(),4===a&&(x(),w()),b[h]("readystatechange",o("readystatechange")),4===a&&(b[h]("load",o("load")),b[h]("loadend",o("loadend")))},4>c?(e(),void 0):(f=r.listeners(d),g=function(){var a;return f.length?(a=f.shift(),2===a.length?(a(s,t),g()):3===a.length?a(s,t,g):void 0):e()},g(),void 0)},y.onreadystatechange=function(){try{2===y[k]&&i()}catch(a){}4===y[k]&&(v=!1,i(),c()),u(y[k])},b=g(),b[j]("progress",function(){return u(3)}),q(f,y,b),s.on=function(a,c){b[j](a,c)},s.fire=function(a,c){b[h](a,c)},b.withCredentials=!1,b.response=null,b.status=0,b.open=function(a,b,c,d,e){if(s.method=a,s.url=b,c===!1)throw"sync xhr not supported by XHook";s.user=d,s.pass=e,u(1)},b.send=function(a){var c,d,f;s.body=a,f=function(){var a,c,d,e,f,g,h;for(v=!0,y.open(s.method,s.url,!0,s.user,s.pass),g=["responseType","timeout"],e=0,f=g.length;f>e;e++)c=g[e],y[c]=s[c]||b[c];h=s.headers;for(a in h)d=h[a],y.setRequestHeader(a,d);y.send(s.body)},c=r.listeners(e),d=function(){var a,b;return c.length?(a=function(a){return"object"!=typeof a||"number"!=typeof a.status&&"number"!=typeof t.status?(d(),void 0):(p(a,t),u(4),void 0)},a.head=function(a){return p(a,t),u(2)},a.text=function(a){return t.text=a,u(3)},b=c.shift(),1===b.length?a(b(s)):2===b.length?b(s,a):void 0):f()},d()},b.abort=function(){v&&y.abort(),b[h]("abort",arguments)},b.setRequestHeader=function(a,b){s.headers[a]=b},b.getResponseHeader=function(a){return t.headers[a]},b.getAllResponseHeaders=function(){return n(t.headers)},y.overrideMimeType&&(b.overrideMimeType=function(){return y.overrideMimeType.apply(y,arguments)}),b.upload=s.upload=g(),y.upload&&q(f.concat(l),y.upload,b.upload),b},(this.define||Object)((this.exports||this).xhook=r)}(a,b);{var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;[].slice}for(i=location.protocol+"//"+location.host,z=function(b){var c;return b="xdomain ("+i+"): "+b,c=a.console=a.console||{},c.warn?c.warn(b):alert(b)},H=["postMessage","JSON"],B=0,E=H.length;E>B;B++)if(j=H[B],!a[j])return z("requires '"+j+"' and this browser does not support it"),void 0;for(d="V0",l=function(){return(Math.random()*Math.pow(2,32)).toString(16)},q=function(a){return/(https?:\/\/[^\/\?]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:null},y=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".+"),new RegExp("^"+b+"$"))},o=function(c){return b.addEventListener?a.addEventListener("message",c):a.attachEvent("onmessage",c)},u=function(a){return JSON.stringify(a)},k=function(a){return JSON.parse(a)},n=null,f=function(a){var b,c;null===n&&(n={},v());for(b in a)c=a[b],n[b]=c},v=function(){throw"TODO create id => proxy request map"},x=null,g=function(a){var b,c;null===x&&(x={},w());for(b in a)c=a[b],x[b]=c},w=function(){return o(function(a){var b;return null!=(b=e.prototype.frames[a.origin])?b.recieve(a):void 0}),xhook.before(function(a,b){var c,d,f;return f=q(a.url),f&&x[f.origin]?(a.async===!1&&z("sync not supported"),d=new e(f.origin,x[f.origin]),c=d.channel(function(d){return"response"===d.type?(b(d.resp),c.close()):"event"===d.type?a.fire.apply(null,d.event):void 0}),c.send({type:"request",req:a}),a.on("abort",function(){return c.send({type:"abort"})}),void 0):b()})},e=function(){function a(a,c){return this.origin=a,this.proxyPath=c,this.frames[this.origin]?this.frames[this.origin]:(this.frames[this.origin]=this,this.listeners={},this.frame=b.createElement("iframe"),this.frame.id=this.frame.name="xdomain-"+l(),this.frame.src=this.origin+this.proxyPath,this.frame.setAttribute("style","display:none;"),b.body.appendChild(this.frame),this.waits=0,this.waiters=[],this.ready=!1,void 0)}return a.prototype.frames={},a.prototype.channel=function(a){var b,c=this;return b=l(),this.open(b,a),{send:function(a){return c.send(b,a)},close:function(){return c.close(b)}}},a.prototype.open=function(a,b){if(this.listeners[a])throw"already open: "+a;this.listeners[a]=b},a.prototype.close=function(a){delete this.listeners[a]},a.prototype.send=function(a,b){var c=this;this.readyCheck(function(){return c.frame.contentWindow.postMessage(u({id:a,msg:b}),c.origin)})},a.prototype.recieve=function(a){var b,c;return/^XPING(_(V\d+))?$/.test(a.data)?RegExp.$2!==d?(z("your master is not compatible with your slave, check your xdomain.js verison"),void 0):(this.ready=!0,void 0):(c=k(a.data),b=this.listeners[c.id],b&&b(c.msg),void 0)},a.prototype.readyCheck=function(a){var b,d=this;return this.ready?a():(this.waiters.push(a),1===this.waiters.length&&(b=function(){if(!d.ready){if(d.waits++>=A.timeout/c)throw"Timeout connecting to iframe: "+d.origin;return setTimeout(b,c)}for(;d.waiters.length;)d.waiters.shift()()},b()),void 0)},a}(),A=function(a){a&&(a.masters&&f(a.masters),a.slaves&&g(a.slaves))},A.parseUrl=q,A.origin=i,A.timeout=15e3,c=100,a.xdomain=A,I=b.getElementsByTagName("script"),C=0,F=I.length;F>C;C++)if(t=I[C],/xdomain/.test(t.src))for(J=["","data-"],D=0,G=J.length;G>D;D++){if(r=J[D],h=t.getAttribute(r+"slave")){if(p=q(h),!p)return;s={},s[p.origin]=p.path,g(s);break}h=t.getAttribute(r+"master"),h&&(m={},m[h]=/./,f(m))}}(window,document);