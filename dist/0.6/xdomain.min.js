// XDomain - v0.6.0 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2014
!function(a,b){!function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;n=a.document,d="before",c="after",j="readyState",i="addEventListener",h="removeEventListener",g="dispatchEvent",l="XMLHttpRequest",k=["load","loadend","loadstart"],e=["progress","abort","error","timeout"],(t=Array.prototype).indexOf||(t.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),r=function(a,b){return Array.prototype.slice.call(a,b)},p=function(a,b){var c,d;for(c in a)if(d=a[c],"returnValue"!==c)try{b[c]=a[c]}catch(e){}return b},q=function(a,b,c){var d,e,f,h;for(e=function(a){return function(d){var e,f,h;e={};for(f in d)"returnValue"!==f&&(h=d[f],e[f]=h===b?c:h);return c[g](a,e)}},f=0,h=a.length;h>f;f++)d=a[f],b["on"+d]=e(d)},o=function(a){var b;if(null!=n.createEventObject)return b=n.createEventObject(),b.type=a,b;try{return new Event(a)}catch(c){return{type:a}}},f=function(a){var c,d,e;return d={},e=function(a){return d[a]||[]},c={},c[i]=function(a,c,f){d[a]=e(a),d[a].indexOf(c)>=0||(f=f===b?d[a].length:f,d[a].splice(f,0,c))},c[h]=function(a,b){var c;c=e(a).indexOf(b),-1!==c&&e(a).splice(c,1)},c[g]=function(){var d,f,g,h,i,j,k,l;for(d=r(arguments),f=d.shift(),a||(d[0]=p(d[0],o(f))),h=c["on"+f],h&&h.apply(b,d),l=e(f).concat(e("*")),g=j=0,k=l.length;k>j;g=++j)i=l[g],i.apply(b,d)},a&&(c.listeners=function(a){return r(e(a))},c.on=c[i],c.off=c[h],c.fire=c[g],c.once=function(a,b){var d;return d=function(){return c.off(a,d),b.apply(null,arguments)},c.on(a,d)},c.destroy=function(){return d={}}),c},s=f(!0),s.EventEmitter=f,s[d]=function(a,b){if(a.length<1||a.length>2)throw"invalid hook";return s[i](d,a,b)},s[c]=function(a,b){if(a.length<2||a.length>3)throw"invalid hook";return s[i](c,a,b)},m=s.headers=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},s[l]=a[l],a[l]=function(){var a,b,h,n,o,r,t,u,v,w,x;return x=new s[l],u=!1,o={},o.headers={},r={},r.headers={},n=function(){var a,b,c;r.status=x.status,r.statusText=x.statusText,c=m(x.getAllResponseHeaders());for(a in c)b=c[a],r.headers[a]||(r.headers[a]=b)},h=function(){try{r.text=x.responseText}catch(a){}try{r.xml=x.responseXML}catch(a){}r.data=x.response||r.text},w=function(){b.status=r.status,b.statusText=r.statusText},v=function(){b.response=r.data||r.text||null,b.responseText=r.text||"",b.responseXML=r.xml||null},a=0,t=function(d){var e,f,h;return e=function(){for(;d>a&&4>a;)b[j]=++a,1===a&&b[g]("loadstart",{}),2===a&&w(),4===a&&(w(),v()),b[g]("readystatechange",{}),4===a&&(b[g]("load",{}),b[g]("loadend",{}))},4>d?(e(),void 0):(f=s.listeners(c),h=function(){var a;return f.length?(a=f.shift(),2===a.length?(a(o,r),h()):3===a.length?a(o,r,h):void 0):e()},h(),void 0)},x.onreadystatechange=function(){try{2===x[j]&&n()}catch(a){}4===x[j]&&(u=!1,n(),h()),t(x[j])},b=o.xhr=f(),b[i]("progress",function(){return t(3)}),q(e,x,b),b.withCredentials=!1,b.response=null,b.status=0,b.open=function(a,b,c,d,e){if(o.method=a,o.url=b,c===!1)throw"sync xhr not supported by XHook";o.user=d,o.pass=e,t(1)},b.send=function(a){var c,e,f,g,h,i,j,k;for(k=["type","timeout"],i=0,j=k.length;j>i;i++)e=k[i],f="type"===e?"responseType":e,o[e]=b[f];o.body=a,h=function(){var a,b,c,d,g,h;for(u=!0,x.open(o.method,o.url,!0,o.user,o.pass),g=["type","timeout"],c=0,d=g.length;d>c;c++)e=g[c],f="type"===e?"responseType":e,x[f]=o[e];h=o.headers;for(a in h)b=h[a],x.setRequestHeader(a,b);x.send(o.body)},c=s.listeners(d),g=function(){var a,b;return c.length?(a=function(a){return"object"!=typeof a||"number"!=typeof a.status&&"number"!=typeof r.status?(g(),void 0):(p(a,r),t(4),void 0)},a.head=function(a){return p(a,r),t(2)},a.progress=function(a){return p(a,r),t(3)},b=c.shift(),1===b.length?a(b(o)):2===b.length?b(o,a):void 0):h()},g()},b.abort=function(){u&&x.abort(),b[g]("abort",{})},b.setRequestHeader=function(a,b){o.headers[a]=b},b.getResponseHeader=function(a){return r.headers[a]},b.getAllResponseHeaders=function(){return m(r.headers)},x.overrideMimeType&&(b.overrideMimeType=function(){return x.overrideMimeType.apply(x,arguments)}),x.upload&&(b.upload=o.upload=f(),q(e.concat(k),x.upload,b.upload)),b},(this.define||Object)((this.exports||this).xhook=s)}(this);var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V;F=null,g=function(a){var b,c;null===F&&(F={},r());for(b in a)c=a[b],F[b]=c},n={},o=function(a,b){var c;return n[a]?n[a]:(c=document.createElement("iframe"),c.id=c.name=p(),c.src=a+b,c.setAttribute("style","display:none;"),document.body.appendChild(c),n[a]=c.contentWindow)},r=function(){return xhook.before(function(a,b){var c,d,e;return d=A(a.url),d&&F[d.origin]?(v("proxying request slave: '"+d.origin+"'"),a.async===!1?(L("sync not supported"),b()):(c=o(d.origin,F[d.origin]),e=i(c),e.on("response",function(a){return b(a),e.close()}),e.on("abort",function(){return a.abort(),e.close()}),e.on("xhr-event",function(){return a.xhr.dispatchEvent.apply(null,arguments)}),e.on("xhr-upload-event",function(){return a.xhr.upload.dispatchEvent.apply(null,arguments)}),e.emit("request",J(a)),void 0)):(v("no slave matching: '"+d.origin+"'"),b())})},x=null,f=function(a){var b,c;null===x&&(x={},s());for(b in a)c=a[b],x[b]=c},s=function(){return u(function(a,b){var c,d,e,f;"null"===a&&(a="*"),e=null;for(c in x){f=x[c];try{if(d=K(c),d.test(a)){e=K(f);break}}catch(g){}}return e?(b.once("request",function(a){var c,d,g,h,i;if(v("request: "+a.method+" "+a.url),d=A(a.url),!d||!e.test(d.path))return L("blocked request to path: '"+d.path+"' by regex: "+f),b.close(),void 0;h=new XMLHttpRequest,h.open(a.method,a.url),h.addEventListener("*",function(a){return b.emit("xhr-event",a.type,J(a))}),h.upload&&h.upload.addEventListener("*",function(a){return b.emit("xhr-upload-event",a.type,J(a))}),h.onabort=function(){return b.emit("abort")},h.onreadystatechange=function(){var a;if(4===h.readyState){a={status:h.status,statusText:h.statusText,data:h.response,headers:xhook.headers(h.getAllResponseHeaders())};try{a.text=h.responseText}catch(c){}try{a.xml=h.responseXML}catch(c){}return b.emit("response",a)}},a.timeout&&(h.timeout=a.timeout),a.type&&(h.responseType=a.type),i=a.headers;for(c in i)g=i[c],h.setRequestHeader(c,g);h.send(a.body||null)}),v("slave listening for requests on socket: "+b.id),void 0):(L("blocked request from: '"+a+"'"),void 0)}),a===a.parent?L("slaves must be in an iframe"):a.parent.postMessage("XDPING_"+d,"*")},y=function(b){return document.addEventListener?a.addEventListener("message",b):a.attachEvent("onmessage",b)},q=null,H={},t=!0,e="XD_CHECK",I=function(){return y(function(a){var c,d,e;if(c=a.data,"string"==typeof c){if(/^XPING_/.test(c))return L("your master is not compatible with your slave, check your xdomain.js verison");if(/^xdomain-/.test(c))c=c.split(",");else try{c=JSON.parse(c)}catch(f){return}}if(c instanceof Array&&(d=c.shift(),/^xdomain-/.test(d)&&(e=H[d],null!==e))){if(e===b){if(!q)return;e=k(d,a.source),q(a.origin,e)}v("receive socket: "+d+": '"+c[0]+"'"),e.fire.apply(e,c)}})},k=function(a,b){var d,f,g,h,i,j;return i=!1,j=H[a]=xhook.EventEmitter(!0),j.id=a,j.once("close",function(){return j.destroy(),j.close()}),h=[],j.emit=function(){var b;b=G(arguments),v("send socket: "+a+": "+b[0]),b.unshift(a),t&&(b=JSON.stringify(b)),i?g(b):h.push(b)},g=function(a){b.postMessage(a,"*")},j.close=function(){j.emit("close"),v("close socket: "+a),H[a]=null},j.once(e,function(b){for(t="string"==typeof b,i=!0,v("ready socket: "+a);h.length;)g(h.shift())}),f=0,d=function(){g([a,e,i,{}]),i||(f++===M.timeout/c?L("Timeout waiting on iframe socket"):setTimeout(d,c))},setTimeout(d),v("new socket: "+a),j},i=function(a){var b;return b=k(p(),a)},u=function(a){q=a},l=location.protocol+"//"+location.host,p=function(){return"xdomain-"+Math.round(Math.random()*Math.pow(2,32)).toString(16)},G=function(a,b){return Array.prototype.slice.call(a,b)},C=function(a){return"xdomain ("+l+"): "+a},j=a.console||{},v=function(a){M.debug&&(a=C(a),"log"in j&&j.log(a))},L=function(a){a=C(a),"warn"in j?j.warn(a):alert(a)},T=["postMessage","JSON"];for(N=0,Q=T.length;Q>N;N++)if(m=T[N],!a[m])return L("requires '"+m+"' and this browser does not support it"),void 0;for(d="V1",A=function(a){return/(https?:\/\/[^\/\?]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:(v("failed to parse url: "+a),null)},K=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".+"),new RegExp("^"+b+"$"))},J=function(a){var b,c,d,e;b={};for(c in a)"returnValue"!==c&&(d=a[c],"function"!=(e=typeof d)&&"object"!==e&&(b[c]=d));return b},M=function(a){a&&(a.masters&&f(a.masters),a.slaves&&g(a.slaves))},M.debug=!1,M.masters=f,M.slaves=g,M.parseUrl=A,M.origin=l,M.timeout=15e3,c=100,a.xdomain=M,U=document.getElementsByTagName("script"),O=0,R=U.length;R>O;O++)if(E=U[O],/xdomain/.test(E.src))for(V=["","data-"],P=0,S=V.length;S>P;P++){if(B=V[P],h=E.getAttribute(B+"slave")){if(z=A(h),!z)break;D={},D[z.origin]=z.path,g(D);break}h=E.getAttribute(B+"master"),h&&(w={},w[h]=/./,f(w))}I()}(this);