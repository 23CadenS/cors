// XDomain - v0.5.0 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2013
!function(a,b){!function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o=[].slice;e="before",d="after",h="readyState",g="Invalid number or parameters. Please see API documentation.",(n=Array.prototype).indexOf||(n.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),f=function(a){var b,d,e;return d={},e=function(a){return d[a]||[]},b={listeners:function(a){return Array.prototype.slice.call(e(a))},on:function(a,b,f){d[a]=e(a),d[a].indexOf(b)>=0||(f=f===c?d[a].length:f,d[a].splice(f,0,b))},off:function(a,b){var c;c=e(a).indexOf(b),-1!==c&&e(a).splice(c,1)},fire:function(){var b,c,d,f,g,h;for(c=arguments[0],b=2<=arguments.length?o.call(arguments,1):[],h=e(c),f=0,g=h.length;g>f;f++)d=h[f],d.apply(a,b)}}},l=f(),m={},m[e]=function(a,b){return l.on(e,a,b)},m[d]=function(a,b){return l.on(d,a,b)},i=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},m.headers=i,k=function(b){var c;return(c=a[b])?a[b]=function(a){return"string"!=typeof a||/\.XMLHTTP/.test(a)?j(new c(a)):void 0}:void 0},k("ActiveXObject"),k("XMLHttpRequest"),j=function(a){var b,c,j,k,m,n,o,p,q,r,s;return 0===l.listeners(e).length&&0===l.listeners(d).length?a:(r=!1,o={timeout:0,headers:{}},p=null,s=f(),n=function(){k.status=p.status,k.statusText=p.statusText,p.headers||(p.headers={})},m=function(){k.responseType=p.type||"",k.response=p.data||null,k.responseText=p.text||p.data||"",k.responseXML=p.xml||null},c=0,q=function(a){var b,e,f;return j(),b=function(){for(;a>c&&4>c;)k[h]=++c,2===c&&n(),4===c&&m(),s.fire("readystatechange"),4===c&&s.fire("load")},4>a?b():(e=l.listeners(d),f=function(){var a;if(!e.length)return b();if(a=e.shift(),2===a.length)return a(o,p),f();if(3===a.length)return a(o,p,f);throw g},f(),void 0)},b=function(b){var c,d,e;c={};for(d in b)e=b[d],c[d]=e===a?k:e;return c},j=function(){var a,b,c;c=[];for(b in k)a=k[b],"function"==typeof a&&/^on(\w+)/.test(b)?c.push(s.on(RegExp.$1,a)):c.push(void 0);return c},a.onreadystatechange=function(){var b,c,d;if(2===a[h]){p.status=a.status,p.statusText=a.statusText,d=i(a.getAllResponseHeaders());for(b in d)c=d[b],p.headers[b]||(p.headers[b]=c)}4===a[h]&&(r=!1,p.type=a.responseType,p.text=a.responseText,p.data=a.response||p.text,p.xml=a.responseXML,q(a[h]))},k={withCredentials:!1,response:null,status:0},k.addEventListener=s.on,k.removeEventListener=s.off,k.dispatchEvent=function(){},k.open=function(a,b,c){o.method=a,o.url=b,o.async=c,q(1)},k.send=function(b){var c,d,f;o.body=b,f=function(){var b,c,d;p={headers:{}},r=!0,a.open(o.method,o.url,o.async),d=o.headers;for(b in d)c=d[b],a.setRequestHeader(b,c);a.send(o.body)},c=l.listeners(e),d=function(){var a,b;if(!c.length)return f();if(a=function(a){return"object"!=typeof a||"number"!=typeof a.status?d():(p=a,q(4),void 0)},b=c.shift(),1===b.length)return a(b(o));if(2===b.length)return b(o,a);throw g},d()},k.abort=function(){return r?a.abort():void 0},k.setRequestHeader=function(a,b){return o.headers[a]=b},k.getResponseHeader=function(a){return p.headers[a]},k.getAllResponseHeaders=function(){return i(p.headers)},k.overrideMimeType=function(){},k.upload={},k)},a.xhook=m}(a,b);var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(e=location.protocol+"//"+location.host,s=function(a){return a="xdomain ("+e+"): "+a,console.warn?console.warn(a):alert(a)},x=["postMessage","JSON"],t=0,v=x.length;v>t;t++)if(f=x[t],!a[f])return s("requires '"+f+"' and this browser does not support it"),void 0;for(c="V0",h=function(){return(Math.random()*Math.pow(2,32)).toString(16)},l=function(a){return/(https?:\/\/[^\/]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:null},r=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".+"),new RegExp("^"+b+"$"))},j=function(c){return b.addEventListener?a.addEventListener("message",c):a.attachEvent("onmessage",c)},n=function(a){return JSON.stringify(a)},g=function(a){return JSON.parse(a)},p=function(b){return j(function(a){var c,d,e,f,h,i,j,k,m,o,p,q,t;i=a.origin,k=null;for(e in b){o=b[e];try{if(f=r(e),f.test(i)){k=r(o);break}}catch(u){}}if(!k)return s("blocked request from: '"+i+"'"),void 0;if(c=a.source,h=g(a.data),p=h.msg,j=l(p.url),!j||!k.test(j.path))return s("blocked request to path: '"+j.path+"' by regex: "+o),void 0;m=new XMLHttpRequest,m.open(p.method,p.url),m.onreadystatechange=function(){var a;if(4===m.readyState)return a={status:m.status,statusText:m.statusText,type:"text",text:m.responseText,headers:xhook.headers(m.getAllResponseHeaders())},c.postMessage(n({id:h.id,msg:a}),i)},t=p.headers;for(d in t)q=t[d],m.setRequestHeader(d,q);return m.send(p.body||null)}),a===a.parent?s("slaves must be in an iframe"):a.parent.postMessage("XPING_"+c,"*")},o=function(a){return j(function(a){var b;return null!=(b=d.prototype.frames[a.origin])?b.recieve(a):void 0}),xhook.before(function(b,c){var e,f;return f=l(b.url),f&&a[f.origin]?(b.async===!1&&s("sync not supported"),e=new d(f.origin,a[f.origin]),e.send(b,c),void 0):c()})},d=function(){function a(a,c){return this.origin=a,this.proxyPath=c,this.frames[this.origin]?this.frames[this.origin]:(this.frames[this.origin]=this,this.listeners={},this.frame=b.createElement("iframe"),this.frame.id=this.frame.name="xdomain-"+h(),this.frame.src=this.origin+this.proxyPath,this.frame.setAttribute("style","display:none;"),b.body.appendChild(this.frame),this.waits=0,this.ready=!1,void 0)}return a.prototype.frames={},a.prototype.post=function(a){return this.frame.contentWindow.postMessage(a,this.origin)},a.prototype.listen=function(a,b){if(this.listeners[a])throw"already listening for: "+a;return this.listeners[a]=b},a.prototype.unlisten=function(a){return delete this.listeners[a]},a.prototype.recieve=function(a){var b,d;return/^XPING(_(V\d+))?$/.test(a.data)?RegExp.$2!==c?(s("your master is not compatible with your slave, check your xdomain.js verison"),void 0):(this.ready=!0,void 0):(d=g(a.data),(b=this.listeners[d.id])?(this.unlisten(d.id),b(d.msg)):(s("unkown message ("+d.id+")"),void 0))},a.prototype.send=function(a,b){var c=this;return this.readyCheck(function(){var d;return d=h(),c.listen(d,function(a){return b(a)}),c.post(n({id:d,msg:a}))})},a.prototype.readyCheck=function(a){var b=this;if(this.ready===!0)return a();if(this.waits++>=100)throw"Timeout connecting to iframe: "+this.origin;return setTimeout(function(){return b.readyCheck(a)},100)},a}(),a.xdomain=function(a){a&&(a.masters&&p(a.masters),a.slaves&&o(a.slaves))},xdomain.origin=e,y=b.getElementsByTagName("script"),u=0,w=y.length;w>u;u++)if(m=y[u],/xdomain/.test(m.src)){if(m.hasAttribute("slave")){if(k=l(m.getAttribute("slave")),!k)return;q={},q[k.origin]=k.path,xdomain({slaves:q})}m.hasAttribute("master")&&(i={},i[m.getAttribute("master")]=/./,xdomain({masters:i}))}}(window,document);