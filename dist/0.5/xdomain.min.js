// XDomain - v0.5.0 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2013
!function(a,b){!function(a,b,c){var d,f,g,h,i,j,k,l,m,n,o,p=[].slice;f="before",d="after",i="readyState",h="Invalid number or parameters. Please see API documentation.",(o=Array.prototype).indexOf||(o.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),g=function(a){var b,d,e;return d={},e=function(a){return d[a]||[]},b={listeners:function(a){return Array.prototype.slice.call(e(a))},on:function(a,b,f){d[a]=e(a),d[a].indexOf(b)>=0||(f=f===c?d[a].length:f,d[a].splice(f,0,b))},off:function(a,b){var c;c=e(a).indexOf(b),-1!==c&&e(a).splice(c,1)},fire:function(){var b,c,d,f,g,h;for(c=arguments[0],b=2<=arguments.length?p.call(arguments,1):[],h=e(c),f=0,g=h.length;g>f;f++)d=h[f],d.apply(a,b)}}},m=g(),n={},n[f]=function(a,b){return m.on(f,a,b)},n[d]=function(a,b){return m.on(d,a,b)},j=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},n.headers=j,l=function(b){var c;c=a[b],c&&(a[b]=function(a){return"string"!=typeof a||/\.XMLHTTP/.test(a)?k(new c(a)):void 0})},l("ActiveXObject"),l("XMLHttpRequest"),k=function(a){var b,k,l,n,o,p,q,r,s,t,u,v,w,x,y;if(0===m.listeners(f).length&&0===m.listeners(d).length)return a;for(u=!1,r={headers:{}},s=null,v=g(),q=function(){o.status=s.status,o.statusText=s.statusText,s.headers||(s.headers={})},p=function(){o.responseType=s.type||"",o.response=s.data||null,o.responseText=s.text||s.data||"",o.responseXML=s.xml||null},k=0,t=function(a){var b,c,e;return n(),b=function(){for(;a>k&&4>k;)o[i]=++k,2===k&&q(),4===k&&p(),v.fire("readystatechange"),4===k&&v.fire("load")},4>a?b():(c=m.listeners(d),e=function(){var a;if(!c.length)return b();if(a=c.shift(),2===a.length)return a(r,s),e();if(3===a.length)return a(r,s,e);throw h},e(),void 0)},b=function(b){var c,d,e;c={};for(d in b)e=b[d],c[d]=e===a?o:e;return c},n=function(){var b,d,e,f,g;for(g=["timeout"],e=0,f=g.length;f>e;e++)d=g[e],a[d]&&r[d]===c&&(r[d]=a[d]);for(d in o)b=o[d],"function"==typeof b&&/^on(\w+)/.test(d)&&v.on(RegExp.$1,b)},a.onreadystatechange=function(){var b,c,d;if(2===a[i]){s.status=a.status,s.statusText=a.statusText,d=j(a.getAllResponseHeaders());for(b in d)c=d[b],s.headers[b]||(s.headers[b]=c)}4===a[i]&&(u=!1,s.type=a.responseType,s.text=a.responseText,s.data=a.response||s.text,s.xml=a.responseXML,t(a[i]))},y=["abort","progress"],w=0,x=y.length;x>w;w++)l=y[w],a["on"+l]=function(a){return v.fire(l,b(a))};return o={withCredentials:!1,response:null,status:0},o.addEventListener=function(a,b){return v.on(e,b)},o.removeEventListener=v.off,o.dispatchEvent=function(){},o.open=function(a,b,c){r.method=a,r.url=b,r.async=c,t(1)},o.send=function(b){var c,d,e;r.body=b,e=function(){var b,c,d;s={headers:{}},u=!0,a.open(r.method,r.url,r.async),a.timeout=r.timeout,d=r.headers;for(b in d)c=d[b],a.setRequestHeader(b,c);a.send(r.body)},c=m.listeners(f),d=function(){var a,b;if(!c.length)return e();if(a=function(a){return"object"!=typeof a||"number"!=typeof a.status?d():(s=a,t(4),void 0)},b=c.shift(),1===b.length)return a(b(r));if(2===b.length)return r.async=!0,b(r,a);throw h},d()},o.abort=function(){u&&a.abort(),v.fire("abort",arguments)},o.setRequestHeader=function(a,b){r.headers[a]=b},o.getResponseHeader=function(a){return s.headers[a]},o.getAllResponseHeaders=function(){return j(s.headers)},o.upload=g(),o},a.xhook=n}(a,b);var c,d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D;for(h=location.protocol+"//"+location.host,x=function(a){return a="xdomain ("+h+"): "+a,console.warn?console.warn(a):alert(a)},C=["postMessage","JSON"],y=0,A=C.length;A>y;y++)if(i=C[y],!a[i])return x("requires '"+i+"' and this browser does not support it"),void 0;for(c="V0",k=function(){return(Math.random()*Math.pow(2,32)).toString(16)},p=function(a){return/(https?:\/\/[^\/]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:null},w=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".+"),new RegExp("^"+b+"$"))},n=function(c){return b.addEventListener?a.addEventListener("message",c):a.attachEvent("onmessage",c)},s=function(a){return JSON.stringify(a)},j=function(a){return JSON.parse(a)},m=null,f=function(a){var b,c;null===m&&(m={},t());for(b in a)c=a[b],m[b]=c},t=function(){return n(function(a){var b,c,d,e,f,g,h,i,k,l,n,o,q;g=a.origin,i=null;for(d in m){l=m[d];try{if(e=w(d),e.test(g)){i=w(l);break}}catch(r){}}if(!i)return x("blocked request from: '"+g+"'"),void 0;if(b=a.source,f=j(a.data),n=f.msg,h=p(n.url),!h||!i.test(h.path))return x("blocked request to path: '"+h.path+"' by regex: "+l),void 0;k=new XMLHttpRequest,k.open(n.method,n.url),k.onreadystatechange=function(){var a;if(4===k.readyState)return a={status:k.status,statusText:k.statusText,type:"text",text:k.responseText,headers:xhook.headers(k.getAllResponseHeaders())},b.postMessage(s({id:f.id,msg:a}),g)},q=n.headers;for(c in q)o=q[c],k.setRequestHeader(c,o);return k.send(n.body||null)}),a===a.parent?x("slaves must be in an iframe"):a.parent.postMessage("XPING_"+c,"*")},v=null,g=function(a){var b,c;null===v&&(v={},u());for(b in a)c=a[b],v[b]=c},u=function(){return n(function(a){var b;return null!=(b=d.prototype.frames[a.origin])?b.recieve(a):void 0}),xhook.before(function(a,b){var c,e;return e=p(a.url),e&&v[e.origin]?(a.async===!1&&x("sync not supported"),c=new d(e.origin,v[e.origin]),c.ready?(c.send(a,b),void 0):b()):b()})},d=function(){function a(a,c){return this.origin=a,this.proxyPath=c,this.frames[this.origin]?this.frames[this.origin]:(this.frames[this.origin]=this,this.listeners={},this.frame=b.createElement("iframe"),this.frame.id=this.frame.name="xdomain-"+k(),this.frame.src=this.origin+this.proxyPath,this.frame.setAttribute("style","display:none;"),b.body.appendChild(this.frame),this.waits=0,this.ready=!1,void 0)}return a.prototype.frames={},a.prototype.post=function(a){this.frame.contentWindow.postMessage(a,this.origin)},a.prototype.listen=function(a,b){if(this.listeners[a])throw"already listening for: "+a;this.listeners[a]=b},a.prototype.unlisten=function(a){delete this.listeners[a]},a.prototype.recieve=function(a){var b,d;return/^XPING(_(V\d+))?$/.test(a.data)?RegExp.$2!==c?(x("your master is not compatible with your slave, check your xdomain.js verison"),void 0):(this.ready=!0,void 0):(d=j(a.data),(b=this.listeners[d.id])?(this.unlisten(d.id),b(d.msg),void 0):(x("unkown message ("+d.id+")"),void 0))},a.prototype.send=function(a,b){var c=this;this.readyCheck(function(){var d;return d=k(),c.listen(d,function(a){return b(a)}),c.post(s({id:d,msg:a}))})},a.prototype.readyCheck=function(a){var b=this;if(this.ready===!0)return a();if(this.waits++>=100)throw"Timeout connecting to iframe: "+this.origin;setTimeout(function(){return b.readyCheck(a)},100)},a}(),a.xdomain=function(a){a&&(a.masters&&f(a.masters),a.slaves&&g(a.slaves))},xdomain.origin=h,D=b.getElementsByTagName("script"),z=0,B=D.length;B>z;z++)if(r=D[z],/xdomain/.test(r.src)){if(r.hasAttribute("slave")){if(o=p(r.getAttribute("slave")),!o)return;q={},q[o.origin]=o.path,g(q)}r.hasAttribute("master")&&(l={},l[r.getAttribute("master")]=/./,f(l))}}(window,document);