/** XDomain - v0.0.1 - 2013/04/10
 * 
 * Copyright (c) 2013 Jaime Pillora - MIT
 */
(function(t,i,r){(function(){"use strict";var n,e,o,s,a,u,h,c,d,f,l,g,p,m,v,y,w,x;w=t.top!==t,n=$(t),m=$.ajax,s="__xdomain_PING",a="__xdomain_PONG",g={masters:{},slaves:{}},u={},l={},f=function(t,i){if(l[t])throw"already listening for: "+t;return l[t]=i},x=function(t){return delete l[t]},c=function(){return(Math.random()*Math.pow(2,32)).toString(16)},p=function(t){var i;return i=t.match(/(https?:\/\/[^\/]+)(\/.*)/),i&&{origin:i[1],path:i[2]}},d=function(t,i){var r;return r=function(){},r.prototype=t,$.extend(!0,new r,i)},y=function(t){return JSON.stringify(t)},h=function(t){return JSON.parse(t)},v=w?function(t){var i,n,e,o;if(i=t.originalEvent,e=i.origin,i.data===s)return i.source.postMessage(a,e),r;if(n=h(i.data),o=g.masters[e],!o)throw"Origin not allowed: "+e;if("*"!==o)throw"Path checks not implemented";return m(n.payload).always(function(){var t,r;return t=Array.prototype.slice.call(arguments),r=y({id:n.id,args:t}),i.source.postMessage(r,i.origin)})}:function(t){var i,n,e;return n=t.originalEvent,n.data===a?(u[n.origin].ready=!0,r):(e=h(n.data),i=l[e.id],i?i(e.args):(console.warn("missing id",e.id),r))},n.on("message",v),o=function(){function t(t,n){var e=this;return this.origin=t,u[this.origin]?u[this.origin]:(this.id=c(),this.frame=i.createElement("iframe"),this.frame.id=this.id,this.frame.name=this.id,this.frame.src=this.origin+n,$(function(){return $("body").append($(e.frame).hide()),e.win=e.frame.contentWindow}),u[this.origin]=this,this.ready=!1,r)}return t.prototype.send=function(t,i){var r=this;return this.check(function(){var n;return n=c(),f(n,function(t){return x(n),i(t)}),r.win.postMessage(y({id:n,payload:t}),r.origin)})},t.prototype.check=function(t){var i,n,e,o=this;return this.ready?t():(i=0,n=3,e=setInterval(function(){if(o.ready)return clearInterval(e),t(),r;try{return o.win.postMessage(s,o.origin)}catch(a){if(i++>=n)throw clearInterval(e),"timeout"}},500))},t}(),e=function(){function t(t,i,r){var n;if(this.origin=t,this.url=i,this.opts=r,n=g.slaves[this.origin],!n)throw"Missing slave origin: "+this.origin;this.frame=new o(this.origin,n),this.d=$.Deferred(),this.frame.send(this.opts,$.proxy(this.handleResponse,this)),this.d.promise()}return t.prototype.handleResponse=function(t){return"success"===t[1]?this.d.resolve.apply(this.d,t):"error"===t[1]?this.d.reject.apply(this.d,t):r},t}(),$.xdomain=function(t){return $.extend(g,t)},$.ajax=function(t,i){var r,n;if(null==i&&(i={}),"string"==typeof t?i.url=t:(i=t,t=i.url),!t)throw"url required";return n=p(t),n&&n.origin?(r=new e(n.origin,t,i),r.d):m.call($,t,i)}}).call(this)})(window,document);