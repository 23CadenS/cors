/** XDomain - v0.0.1 - 2013/04/14
 * 
 * Copyright (c) 2013 Jaime Pillora - MIT
 */
(function(t,e,n){(function(){var t=!1,e=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(n){function i(){!t&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;t=!0;var o=new this;t=!1;for(var s in n)o[s]="function"==typeof n[s]&&"function"==typeof r[s]&&e.test(n[s])?function(t,e){return function(){var n=this._super;this._super=r[t];var i=e.apply(this,arguments);return this._super=n,i}}(s,n[s]):n[s];return i.prototype=o,i.prototype.constructor=i,i.extend=arguments.callee,i}})(),function(t){"use strict";var i={trace:function(e){"localhost"===t.location.host&&"a.example.com"===t.location.host&&t.console!==n&&t.console.log("Porthole: "+e)},error:function(e){t.console!==n&&t.console.error("Porthole: "+e)}};i.WindowProxy=function(){},i.WindowProxy.prototype={post:function(){},addEventListener:function(){},removeEventListener:function(){}},i.WindowProxyBase=Class.extend({init:function(e){e===n&&(e=""),this.targetWindowName=e,this.origin=t.location.protocol+"//"+t.location.host,this.eventListeners=[]},getTargetWindowName:function(){return this.targetWindowName},getOrigin:function(){return this.origin},getTargetWindow:function(){return i.WindowProxy.getTargetWindow(this.targetWindowName)},post:function(e,i){i===n&&(i="*"),this.dispatchMessage({data:e,sourceOrigin:this.getOrigin(),targetOrigin:i,sourceWindowName:t.name,targetWindowName:this.getTargetWindowName()})},addEventListener:function(t){return this.eventListeners.push(t),t},removeEventListener:function(t){var e;try{e=this.eventListeners.indexOf(t),this.eventListeners.splice(e,1)}catch(n){this.eventListeners=[]}},dispatchEvent:function(t){var e;for(e=0;this.eventListeners.length>e;e++)try{this.eventListeners[e](t)}catch(n){}}}),i.WindowProxyLegacy=i.WindowProxyBase.extend({init:function(t,e){if(this._super(e),null===t)throw this.proxyIFrameElement=null,Error("proxyIFrameUrl can't be null");this.proxyIFrameName=this.targetWindowName+"ProxyIFrame",this.proxyIFrameLocation=t,this.proxyIFrameElement=this.createIFrameProxy()},createIFrameProxy:function(){var t=e.createElement("iframe");return t.setAttribute("id",this.proxyIFrameName),t.setAttribute("name",this.proxyIFrameName),t.setAttribute("src",this.proxyIFrameLocation),t.setAttribute("frameBorder","1"),t.setAttribute("scrolling","auto"),t.setAttribute("width",30),t.setAttribute("height",30),t.setAttribute("style","position: absolute; left: -100px; top:0px;"),t.style.setAttribute&&t.style.setAttribute("cssText","position: absolute; left: -100px; top:0px;"),e.body.appendChild(t),t},dispatchMessage:function(e){var n=t.encodeURIComponent;if(this.proxyIFrameElement){var r=this.proxyIFrameLocation+"#"+n(i.WindowProxy.serialize(e));this.proxyIFrameElement.setAttribute("src",r),this.proxyIFrameElement.height=this.proxyIFrameElement.height>50?50:100}}}),i.WindowProxyHTML5=i.WindowProxyBase.extend({init:function(t,e){this._super(e),this.eventListenerCallback=null},dispatchMessage:function(t){this.getTargetWindow().postMessage(i.WindowProxy.serialize(t),t.targetOrigin)},addEventListener:function(e){if(0===this.eventListeners.length){var n=this;this.eventListenerCallback=function(t){n.eventListener(n,t)},t.addEventListener("message",this.eventListenerCallback,!1)}return this._super(e)},removeEventListener:function(e){this._super(e),0===this.eventListeners.length&&(t.removeEventListener("message",this.eventListenerCallback),this.eventListenerCallback=null)},eventListener:function(t,e){var n=i.WindowProxy.unserialize(e.data);!n||""!=t.targetWindowName&&n.sourceWindowName!=t.targetWindowName||t.dispatchEvent(new i.MessageEvent(n.data,e.origin,t))}}),"function"!=typeof t.postMessage?(i.trace("Using legacy browser support"),i.WindowProxy=i.WindowProxyLegacy.extend({})):(i.trace("Using built-in browser support"),i.WindowProxy=i.WindowProxyHTML5.extend({})),i.WindowProxy.serialize=function(t){if("undefined"==typeof JSON)throw Error("Porthole serialization depends on JSON!");return JSON.stringify(t)},i.WindowProxy.unserialize=function(t){if("undefined"==typeof JSON)throw Error("Porthole unserialization dependens on JSON!");try{var e=JSON.parse(t)}catch(n){return!1}return e},i.WindowProxy.getTargetWindow=function(e){return""===e?top:"top"===e||"parent"===e?t[e]:parent.frames[e]},i.MessageEvent=function(t,e,n){this.data=t,this.origin=e,this.source=n},i.WindowProxyDispatcher={forwardMessageEvent:function(){var n,r,o,s=t.decodeURIComponent;e.location.hash.length>0&&(n=i.WindowProxy.unserialize(s(e.location.hash.substr(1))),r=i.WindowProxy.getTargetWindow(n.targetWindowName),o=i.WindowProxyDispatcher.findWindowProxyObjectInWindow(r,n.sourceWindowName),o?o.origin===n.targetOrigin||"*"===n.targetOrigin?o.dispatchEvent(new i.MessageEvent(n.data,n.sourceOrigin,o)):i.error("Target origin "+o.origin+" does not match desired target of "+n.targetOrigin):i.error("Could not find window proxy object on the target window"))},findWindowProxyObjectInWindow:function(t,e){var n;if(t.RuntimeObject&&(t=t.RuntimeObject()),t)for(n in t)if(t.hasOwnProperty(n))try{if(null!==t[n]&&"object"==typeof t[n]&&t[n]instanceof t.Porthole.WindowProxy&&t[n].getTargetWindowName()===e)return t[n]}catch(i){}return null},start:function(){t.addEventListener?t.addEventListener("resize",i.WindowProxyDispatcher.forwardMessageEvent,!1):e.body.attachEvent?t.attachEvent("onresize",i.WindowProxyDispatcher.forwardMessageEvent):i.error("Cannot attach resize event")}},t.exports!==n?t.exports.Porthole=i:t.Porthole=i}(this),function(){"use strict";var i,r,o,s,a,c,u,h,d,p,l,f,g,y;i=$(t),f=$.ajax,o="__xdomain_PING",s="__xdomain_PONG",p={masters:{},slaves:{}},location.origin||(location.origin=location.protocol+"//"+location.host),c=function(){return(Math.random()*Math.pow(2,32)).toString(16)},l=function(t){var e;return e=t.match(/(https?:\/\/[^\/]+)(\/.*)/),e&&{origin:e[1],path:e[2]}},d=function(t,e){var n;return n=function(){},n.prototype=t,$.extend(!0,new n,e)},g=function(t){return JSON.stringify(t)},a=function(t){return JSON.parse(t)},y=function(e){var i,r,u;if(i=p.masters[e],!i)throw"Origin not allowed: "+e;return u=e+i,r=new Porthole.WindowProxy(u),r.addEventListener(function(t){var i;if(t.data===o)return r.post(s,e),n;if(i=a(t.data),t.origin!==e)throw"Origin mismatch";return f(i.payload).always(function(){var e,n;return e=Array.prototype.slice.call(arguments),n=g({id:i.id,args:e}),r.post(n,t.origin)})}),t["windowProxy"+c()]=r},r=function(){function i(n){var i,r,o=this;if(this.origin=n,this.frames[this.origin])return this.frames[this.origin];if(this.frames[this.origin]=this,this.proxyPath=p.slaves[n],!this.proxyPath)throw"Missing slave origin: "+this.origin;this.listeners={},i=c(),this.frame=e.createElement("iframe"),this.frame.id=this.frame.name=i,r=this.origin+this.proxyPath,this.frame.src=r+"#"+encodeURIComponent("XDOMAIN_SLAVE."+location.origin),this.pingPong.attempts=0,this.ready=this.domReady=!1,$(function(){return $("body").append($(o.frame).hide()),o.proxy=new Porthole.WindowProxy(r,i),o.proxy.addEventListener($.proxy(o.recieve,o)),t["windowProxy"+i]=o.proxy})}return i.prototype.frames={},i.prototype.listen=function(t,e){if(this.listeners[t])throw"already listening for: "+t;return this.listeners[t]=e},i.prototype.unlisten=function(t){return delete this.listeners[t]},i.prototype.recieve=function(t){var e,i;return t.data===s?(this.ready=!0,n):(i=a(t.data),(e=this.listeners[i.id])?(this.unlisten(i.id),e(i.args)):(console.warn("missing id",i.id),n))},i.prototype.send=function(t,e){var n=this;return this.pingPong(function(){var i;return i=c(),n.listen(i,function(t){return e(t)}),n.proxy.post(g({id:i,payload:t}),n.origin)})},i.prototype.pingPong=function(t){var e=this;if(this.ready)return t(),n;if(this.proxy&&this.proxy.post(o,this.origin),this.pingPong.attempts++>=10)throw"Timeout connecting to iframe: "+this.origin;return setTimeout(function(){return e.pingPong(t)},500)},i}(),$.xdomain=function(t){return $.extend(p,t)},$.ajax=function(t,e){var i,o,s;if(null==e&&(e={}),"string"==typeof t?e.url=t:(e=t,t=e.url),!t)throw"url required";return s=l(t),s&&p.slaves[s.origin]?(o=new r(s.origin),i=$.Deferred(),"function"==typeof e.success&&i.done(e.success),"function"==typeof e.error&&i.fail(e.error),"function"==typeof e.complete&&i.always(e.complete),o.send(e,function(t){return"success"===t[1]?i.resolve.apply(i,t):"error"===t[1]?i.reject.apply(i,t):n}),i.promise()):f.call($,t,e)},u=decodeURIComponent(location.hash.substr(1)),h=u.match(/^XDOMAIN_([A-Z]+)\.#?(.*)?/),h&&"SLAVE"===h[1]&&$(function(){return y(h[2])}),$(function(){return Porthole.WindowProxyDispatcher.start()})}.call(this)})(window,document);