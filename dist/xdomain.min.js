/** XDomain - v0.2.0 - 2013/07/28
 * 
 * Copyright (c) 2013 Jaime Pillora - MIT
 */
(function(t,n,r){(function(){"use strict";var e,i,o,s,a,u,c,f,p,l,h,d,g,m,y,v,w,x,P;for(p=function(n){return t.console!==r?console.log("xdomain ("+location.origin+"): "+n):r},P=["postMessage","JSON"],w=0,x=P.length;x>w;w++)if(a=P[w],!t[a])return p("requires '"+a+"' and this browser does not support it"),r;e=$(t),g=$.ajax,o="__xdomain_PING",s="__xdomain_PONG",h={masters:{},slaves:{}},location.origin||(location.origin=location.protocol+"//"+location.host),c=function(){return(Math.random()*Math.pow(2,32)).toString(16)},d=function(t){var n;return n=t.match(/(https?:\/\/[^\/]+)(\/.*)/),n&&{origin:n[1],path:n[2]}},f=function(t,n){var r;return r=function(){},r.prototype=t,$.extend(!0,new r,n)},l=function(r){return n.addEventListener?t.addEventListener("message",r):t.attachEvent("onmessage",r)},m=function(t){return JSON.stringify(t)},u=function(t){return JSON.parse(t)},v=function(t){return l(function(n){var e,i,a,c;return(a=t[n.origin])?n.data===o?(n.source.postMessage(s,n.origin),r):(e=u(n.data),a.test&&(i=d(null!=(c=e.payload)?c.url:void 0),i&&!a.test(i.path))?(p("blocked request to path: '"+i.path+"' by regex: "+a),r):g(e.payload).always(function(){var t,r;return t=Array.prototype.slice.call(arguments),r=m({id:e.id,args:t}),n.source.postMessage(r,n.origin)})):(p("blocked request from: '"+n.origin+"'"),r)})},y=function(t){return l(function(t){var n;return n=i.prototype.frames[event.origin],n?n.recieve(t):r}),$.ajax=function(n,e){var o,s,a;if(null==e&&(e={}),"string"==typeof n?e.url=n:(e=n,n=e.url),!n)throw"url required";return a=d(n),a&&t[a.origin]?(s=new i(a.origin,t[a.origin]),o=$.Deferred(),"function"==typeof e.success&&o.done(e.success),"function"==typeof e.error&&o.fail(e.error),"function"==typeof e.complete&&o.always(e.complete),s.send(e,function(t){return"success"===t[1]?o.resolve.apply(o,t):"error"===t[1]?o.reject.apply(o,t):r}),o.promise()):g.call($,n,e)}},i=function(){function t(t,e){var i=this;return this.origin=t,this.proxyPath=e,this.frames[this.origin]?this.frames[this.origin]:(this.frames[this.origin]=this,this.listeners={},this.frame=n.createElement("iframe"),this.frame.id=this.frame.name="xdomain-"+c(),this.frame.src=this.origin+this.proxyPath,$(function(){return $("body").append($(i.frame).hide())}),this.pingPong.attempts=0,this.ready=!1,r)}return t.prototype.frames={},t.prototype.post=function(t){return this.frame.contentWindow.postMessage(t,this.origin)},t.prototype.listen=function(t,n){if(this.listeners[t])throw"already listening for: "+t;return this.listeners[t]=n},t.prototype.unlisten=function(t){return delete this.listeners[t]},t.prototype.recieve=function(t){var n,e;return t.data===s?(this.ready=!0,r):(e=u(t.data),(n=this.listeners[e.id])?(this.unlisten(e.id),n(e.args)):(console.warn("missing id",e.id),r))},t.prototype.send=function(t,n){var r=this;return this.pingPong(function(){var e;return e=c(),r.listen(e,function(t){return n(t)}),r.post(m({id:e,payload:t}))})},t.prototype.pingPong=function(t){var n,r=this;if(this.ready===!0)return t();if((null!=(n=this.frame)?n.contentWindow:void 0)&&this.post(o),this.pingPong.attempts++>=10)throw"Timeout connecting to iframe: "+this.origin;return setTimeout(function(){return r.pingPong(t)},500)},t}(),$.xdomain=function(t){return t?(t.masters&&v(t.masters),t.slaves?y(t.slaves):r):r}}).call(this)})(window,document);