/** XDomain - v0.0.1 - 2013/04/14
 * 
 * Copyright (c) 2013 Jaime Pillora - MIT
 */
(function(t,e,n){(function(){var t=!1,e=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(n){function r(){!t&&this.init&&this.init.apply(this,arguments)}var i=this.prototype;t=!0;var o=new this;t=!1;for(var s in n)o[s]="function"==typeof n[s]&&"function"==typeof i[s]&&e.test(n[s])?function(t,e){return function(){var n=this._super;this._super=i[t];var r=e.apply(this,arguments);return this._super=n,r}}(s,n[s]):n[s];return r.prototype=o,r.prototype.constructor=r,r.extend=arguments.callee,r}})(),function(t){"use strict";var r={trace:function(e){"localhost"===t.location.host&&"a.example.com"===t.location.host&&t.console!==n&&t.console.log("Porthole: "+e)},error:function(e){t.console!==n&&t.console.error("Porthole: "+e)}};r.WindowProxy=function(){},r.WindowProxy.prototype={post:function(){},addEventListener:function(){},removeEventListener:function(){}},r.WindowProxyBase=Class.extend({init:function(e){e===n&&(e=""),this.targetWindowName=e,this.origin=t.location.protocol+"//"+t.location.host,this.eventListeners=[]},getTargetWindowName:function(){return this.targetWindowName},getOrigin:function(){return this.origin},getTargetWindow:function(){return r.WindowProxy.getTargetWindow(this.targetWindowName)},post:function(e,r){r===n&&(r="*"),this.dispatchMessage({data:e,sourceOrigin:this.getOrigin(),targetOrigin:r,sourceWindowName:t.name,targetWindowName:this.getTargetWindowName()})},addEventListener:function(t){return this.eventListeners.push(t),t},removeEventListener:function(t){var e;try{e=this.eventListeners.indexOf(t),this.eventListeners.splice(e,1)}catch(n){this.eventListeners=[]}},dispatchEvent:function(t){var e;for(e=0;this.eventListeners.length>e;e++)try{this.eventListeners[e](t)}catch(n){}}}),r.WindowProxyLegacy=r.WindowProxyBase.extend({init:function(t,e){if(this._super(e),null===t)throw this.proxyIFrameElement=null,Error("proxyIFrameUrl can't be null");this.proxyIFrameName=this.targetWindowName+"ProxyIFrame",this.proxyIFrameLocation=t,this.proxyIFrameElement=this.createIFrameProxy()},createIFrameProxy:function(){var t=e.createElement("iframe");return t.setAttribute("id",this.proxyIFrameName),t.setAttribute("name",this.proxyIFrameName),t.setAttribute("src",this.proxyIFrameLocation),t.setAttribute("frameBorder","1"),t.setAttribute("scrolling","auto"),t.setAttribute("width",30),t.setAttribute("height",30),t.setAttribute("style","position: absolute; left: -100px; top:0px;"),t.style.setAttribute&&t.style.setAttribute("cssText","position: absolute; left: -100px; top:0px;"),e.body.appendChild(t),t},dispatchMessage:function(e){var n=t.encodeURIComponent;if(this.proxyIFrameElement){var i=this.proxyIFrameLocation+"#"+n(r.WindowProxy.serialize(e));this.proxyIFrameElement.setAttribute("src",i),this.proxyIFrameElement.height=this.proxyIFrameElement.height>50?50:100}}}),r.WindowProxyHTML5=r.WindowProxyBase.extend({init:function(t,e){this._super(e),this.eventListenerCallback=null},dispatchMessage:function(t){this.getTargetWindow().postMessage(r.WindowProxy.serialize(t),t.targetOrigin)},addEventListener:function(e){if(0===this.eventListeners.length){var n=this;this.eventListenerCallback=function(t){n.eventListener(n,t)},t.addEventListener("message",this.eventListenerCallback,!1)}return this._super(e)},removeEventListener:function(e){this._super(e),0===this.eventListeners.length&&(t.removeEventListener("message",this.eventListenerCallback),this.eventListenerCallback=null)},eventListener:function(t,e){var n=r.WindowProxy.unserialize(e.data);!n||""!=t.targetWindowName&&n.sourceWindowName!=t.targetWindowName||t.dispatchEvent(new r.MessageEvent(n.data,e.origin,t))}}),"function"!=typeof t.postMessage?(r.trace("Using legacy browser support"),r.WindowProxy=r.WindowProxyLegacy.extend({})):(r.trace("Using built-in browser support"),r.WindowProxy=r.WindowProxyHTML5.extend({})),r.WindowProxy.serialize=function(t){if("undefined"==typeof JSON)throw Error("Porthole serialization depends on JSON!");return JSON.stringify(t)},r.WindowProxy.unserialize=function(t){if("undefined"==typeof JSON)throw Error("Porthole unserialization dependens on JSON!");try{var e=JSON.parse(t)}catch(n){return!1}return e},r.WindowProxy.getTargetWindow=function(e){return""===e?top:"top"===e||"parent"===e?t[e]:parent.frames[e]},r.MessageEvent=function(t,e,n){this.data=t,this.origin=e,this.source=n},r.WindowProxyDispatcher={forwardMessageEvent:function(){var n,i,o,s=t.decodeURIComponent;e.location.hash.length>0&&(n=r.WindowProxy.unserialize(s(e.location.hash.substr(1))),i=r.WindowProxy.getTargetWindow(n.targetWindowName),o=r.WindowProxyDispatcher.findWindowProxyObjectInWindow(i,n.sourceWindowName),o?o.origin===n.targetOrigin||"*"===n.targetOrigin?o.dispatchEvent(new r.MessageEvent(n.data,n.sourceOrigin,o)):r.error("Target origin "+o.origin+" does not match desired target of "+n.targetOrigin):r.error("Could not find window proxy object on the target window"))},findWindowProxyObjectInWindow:function(t,e){var n;if(t.RuntimeObject&&(t=t.RuntimeObject()),t)for(n in t)if(t.hasOwnProperty(n))try{if(null!==t[n]&&"object"==typeof t[n]&&t[n]instanceof t.Porthole.WindowProxy&&t[n].getTargetWindowName()===e)return t[n]}catch(r){}return null},start:function(){t.addEventListener?t.addEventListener("resize",r.WindowProxyDispatcher.forwardMessageEvent,!1):e.body.attachEvent?t.attachEvent("onresize",r.WindowProxyDispatcher.forwardMessageEvent):r.error("Cannot attach resize event")}},t.exports!==n?t.exports.Porthole=r:t.Porthole=r}(this),function(){"use strict";var r,i,o,s,a,u,c,h,d,p,l,f,g,y;r=$(t),f=$.ajax,o="__xdomain_PING",s="__xdomain_PONG",p={masters:{},slaves:{}},u=function(){return(Math.random()*Math.pow(2,32)).toString(16)},l=function(t){var e;return e=t.match(/(https?:\/\/[^\/]+)(\/.*)/),e&&{origin:e[1],path:e[2]}},d=function(t,e){var n;return n=function(){},n.prototype=t,$.extend(!0,new n,e)},g=function(t){return JSON.stringify(t)},a=function(t){return JSON.parse(t)},y=function(e){var r,i,c;if(r=p.masters[e],!r)throw"Origin not allowed: "+e;return c=e+r,i=new Porthole.WindowProxy(c),i.addEventListener(function(t){var r;if(t.data===o)return i.post(s,e),n;if(r=a(t.data),t.origin!==e)throw"Origin mismatch";return f(r.payload).always(function(){var e,n;return e=Array.prototype.slice.call(arguments),n=g({id:r.id,args:e}),i.post(n,t.origin)})}),t["windowProxy"+u()]=i},i=function(){function r(n){var r,i,o=this;if(this.origin=n,this.frames[this.origin])return this.frames[this.origin];if(this.frames[this.origin]=this,this.proxyPath=p.slaves[n],!this.proxyPath)throw"Missing slave origin: "+this.origin;this.listeners={},r=u(),this.frame=e.createElement("iframe"),this.frame.id=this.frame.name=r,i=this.origin+this.proxyPath,this.frame.src=i+"#"+encodeURIComponent("XDOMAIN_SLAVE."+location.origin),this.pingPong.attempts=0,this.ready=this.domReady=!1,$(function(){return $("body").append($(o.frame).hide()),o.proxy=new Porthole.WindowProxy(i,r),o.proxy.addEventListener($.proxy(o.recieve,o)),t["windowProxy"+r]=o.proxy})}return r.prototype.frames={},r.prototype.listen=function(t,e){if(this.listeners[t])throw"already listening for: "+t;return this.listeners[t]=e},r.prototype.unlisten=function(t){return delete this.listeners[t]},r.prototype.recieve=function(t){var e,r;return t.data===s?(this.ready=!0,n):(r=a(t.data),(e=this.listeners[r.id])?(this.unlisten(r.id),e(r.args)):(console.warn("missing id",r.id),n))},r.prototype.send=function(t,e){var n=this;return this.pingPong(function(){var r;return r=u(),n.listen(r,function(t){return e(t)}),n.proxy.post(g({id:r,payload:t}),n.origin)})},r.prototype.pingPong=function(t){var e=this;if(this.ready)return t(),n;if(this.proxy&&this.proxy.post(o,this.origin),this.pingPong.attempts++>=10)throw"Timeout connecting to iframe: "+this.origin;return setTimeout(function(){return e.pingPong(t)},500)},r}(),$.xdomain=function(t){return $.extend(p,t)},$.ajax=function(t,e){var r,o,s;if(null==e&&(e={}),"string"==typeof t?e.url=t:(e=t,t=e.url),!t)throw"url required";return s=l(t),s&&p.slaves[s.origin]?(o=new i(s.origin),r=$.Deferred(),"function"==typeof e.success&&r.done(e.success),"function"==typeof e.error&&r.fail(e.error),"function"==typeof e.complete&&r.always(e.complete),o.send(e,function(t){return"success"===t[1]?r.resolve.apply(r,t):"error"===t[1]?r.reject.apply(r,t):n}),r.promise()):f.call($,t,e)},c=decodeURIComponent(location.hash.substr(1)),h=c.match(/^XDOMAIN_([A-Z]+)\.#?(.*)?/),h&&"SLAVE"===h[1]&&$(function(){return y(h[2])}),$(function(){return Porthole.WindowProxyDispatcher.start()})}.call(this)})(window,document);