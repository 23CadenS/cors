/** XDomain - v0.0.1 - 2013/04/09
 * 
 * Copyright (c) 2013 Jaime Pillora - MIT
 */
(function(t,e,n){(function(){var t=!1,e=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(n){function r(){!t&&this.init&&this.init.apply(this,arguments)}var i=this.prototype;t=!0;var o=new this;t=!1;for(var s in n)o[s]="function"==typeof n[s]&&"function"==typeof i[s]&&e.test(n[s])?function(t,e){return function(){var n=this._super;this._super=i[t];var r=e.apply(this,arguments);return this._super=n,r}}(s,n[s]):n[s];return r.prototype=o,r.prototype.constructor=r,r.extend=arguments.callee,r}})(),function(t){"use strict";var r={trace:function(e){t.console!==n&&t.console.log("Porthole: "+e)},error:function(e){t.console!==n&&t.console.error("Porthole: "+e)}};r.WindowProxy=function(){},r.WindowProxy.prototype={post:function(){},addEventListener:function(){},removeEventListener:function(){}},r.WindowProxyBase=Class.extend({init:function(e){e===n&&(e=""),this.targetWindowName=e,this.origin=t.location.protocol+"//"+t.location.host,this.eventListeners=[]},getTargetWindowName:function(){return this.targetWindowName},getOrigin:function(){return this.origin},getTargetWindow:function(){return r.WindowProxy.getTargetWindow(this.targetWindowName)},post:function(e,r){r===n&&(r="*"),this.dispatchMessage({data:e,sourceOrigin:this.getOrigin(),targetOrigin:r,sourceWindowName:t.name,targetWindowName:this.getTargetWindowName()})},addEventListener:function(t){return this.eventListeners.push(t),t},removeEventListener:function(t){var e;try{e=this.eventListeners.indexOf(t),this.eventListeners.splice(e,1)}catch(n){this.eventListeners=[]}},dispatchEvent:function(t){var e;for(e=0;this.eventListeners.length>e;e++)try{this.eventListeners[e](t)}catch(n){}}}),r.WindowProxyLegacy=r.WindowProxyBase.extend({init:function(t,e){if(this._super(e),null===t)throw this.proxyIFrameElement=null,Error("proxyIFrameUrl can't be null");this.proxyIFrameName=this.targetWindowName+"ProxyIFrame",this.proxyIFrameLocation=t,this.proxyIFrameElement=this.createIFrameProxy()},createIFrameProxy:function(){var t=e.createElement("iframe");return t.setAttribute("id",this.proxyIFrameName),t.setAttribute("name",this.proxyIFrameName),t.setAttribute("src",this.proxyIFrameLocation),t.setAttribute("frameBorder","1"),t.setAttribute("scrolling","auto"),t.setAttribute("width",30),t.setAttribute("height",30),t.setAttribute("style","position: absolute; left: -100px; top:0px;"),t.style.setAttribute&&t.style.setAttribute("cssText","position: absolute; left: -100px; top:0px;"),e.body.appendChild(t),t},dispatchMessage:function(e){var n=t.encodeURIComponent;if(this.proxyIFrameElement){var i=this.proxyIFrameLocation+"#"+n(r.WindowProxy.serialize(e));this.proxyIFrameElement.setAttribute("src",i),this.proxyIFrameElement.height=this.proxyIFrameElement.height>50?50:100}}}),r.WindowProxyHTML5=r.WindowProxyBase.extend({init:function(t,e){this._super(e),this.eventListenerCallback=null},dispatchMessage:function(t){this.getTargetWindow().postMessage(r.WindowProxy.serialize(t),t.targetOrigin)},addEventListener:function(e){if(0===this.eventListeners.length){var n=this;this.eventListenerCallback=function(t){n.eventListener(n,t)},t.addEventListener("message",this.eventListenerCallback,!1)}return this._super(e)},removeEventListener:function(e){this._super(e),0===this.eventListeners.length&&(t.removeEventListener("message",this.eventListenerCallback),this.eventListenerCallback=null)},eventListener:function(t,e){var n=r.WindowProxy.unserialize(e.data);!n||""!=t.targetWindowName&&n.sourceWindowName!=t.targetWindowName||t.dispatchEvent(new r.MessageEvent(n.data,e.origin,t))}}),"function"!=typeof t.postMessage?(r.trace("Using legacy browser support"),r.WindowProxy=r.WindowProxyLegacy.extend({})):(r.trace("Using built-in browser support"),r.WindowProxy=r.WindowProxyHTML5.extend({})),r.WindowProxy.serialize=function(t){if("undefined"==typeof JSON)throw Error("Porthole serialization depends on JSON!");return JSON.stringify(t)},r.WindowProxy.unserialize=function(t){if("undefined"==typeof JSON)throw Error("Porthole unserialization dependens on JSON!");try{var e=JSON.parse(t)}catch(n){return!1}return e},r.WindowProxy.getTargetWindow=function(e){return""===e?top:"top"===e||"parent"===e?t[e]:parent.frames[e]},r.MessageEvent=function(t,e,n){this.data=t,this.origin=e,this.source=n},r.WindowProxyDispatcher={forwardMessageEvent:function(){var n,i,o,s=t.decodeURIComponent;e.location.hash.length>0&&(n=r.WindowProxy.unserialize(s(e.location.hash.substr(1))),i=r.WindowProxy.getTargetWindow(n.targetWindowName),o=r.WindowProxyDispatcher.findWindowProxyObjectInWindow(i,n.sourceWindowName),o?o.origin===n.targetOrigin||"*"===n.targetOrigin?o.dispatchEvent(new r.MessageEvent(n.data,n.sourceOrigin,o)):r.error("Target origin "+o.origin+" does not match desired target of "+n.targetOrigin):r.error("Could not find window proxy object on the target window"))},findWindowProxyObjectInWindow:function(t,e){var n;if(t.RuntimeObject&&(t=t.RuntimeObject()),t)for(n in t)if(t.hasOwnProperty(n))try{if(null!==t[n]&&"object"==typeof t[n]&&t[n]instanceof t.Porthole.WindowProxy&&t[n].getTargetWindowName()===e)return t[n]}catch(r){}return null},start:function(){t.addEventListener?t.addEventListener("resize",r.WindowProxyDispatcher.forwardMessageEvent,!1):e.body.attachEvent?t.attachEvent("onresize",r.WindowProxyDispatcher.forwardMessageEvent):r.error("Cannot attach resize event")}},t.exports!==n?t.exports.Porthole=r:t.Porthole=r}(this),function(){"use strict";var t,n,r;t=function(){function t(t,e){var i;if(this.ajaxOpts=t,null==e&&(e={}),!t)throw"ajax options required";if(!t.url)throw"url required";if(this.url=t.url,i=this.url.match(/https?:\/\/[^\/]+/),!i)throw"invalid url";this.origin=i[0],console.log("origin",this.origin),this.opts=r(this.defaults,e),this.id=n(),this.checkFrame(),this.run()}return t.prototype.frames={},t.prototype.defaults={proxyPath:"/xdomain.html"},t.prototype.checkFrame=function(){var t;if(!this.frames[this.origin])return t=e.createElement("iframe"),t.id=this.origin,t.name=this.origin,t.src=this.origin+this.opts.proxyPath,this.frames[this.origin]=t,$("body").append(t)},t.prototype.run=function(){var t;return t=$.Deferred(),this.d=t.promise()},t}(),$.xdomain=function(e){return $.extend(t.prototype.defaults,e)},$.xdomain.ajax=function(e,n){var r;return r=new t(e,n),r.d},n=function(){return(Math.random()*Math.pow(2,32)).toString(16)},r=function(t,e){var n;return n=function(){},n.prototype=t,$.extend(!0,new n,e)}}.call(this)})(window,document);