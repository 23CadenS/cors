/** XDomain - v0.0.1 - 2013/04/10
 * 
 * Copyright (c) 2013 Jaime Pillora - MIT
 */
(function(t,i,n){(function(){"use strict";var r,o,e,s,a,u,h,c,f,d,l,g,p,m,v,w,y,x;g=function(i){return console&&console.log?console.log("xdomain",t.location.host,": ",i):n},g("init client"),y=t.top!==t,r=$(t),s="__xdomain_PING",a="__xdomain_PONG",p={},u={},l={},d=function(t,i){if(l[t])throw"already listening for: "+t;return l[t]=i},x=function(t){return delete l[t]},c=function(){return(Math.random()*Math.pow(2,32)).toString(16)},m=function(t){var i;return i=t.match(/(https?:\/\/[^\/]+)(\/.*)/),i&&{origin:i[1],path:i[2]}},f=function(t,i){var n;return n=function(){},n.prototype=t,$.extend(!0,new n,i)},w=function(t){return t},h=function(t){return t},v=y?function(t){var i,r,o;return i=t.originalEvent,o=h(i.data),console.log("slave",o),o===s?(i.source.postMessage(a,i.origin),n):(r=o.id,$.ajax(o.payload).always(function(t,n){var o;return o={data:t,result:n},i.source.postMessage({id:r,args:o},i.origin)}))}:function(t){var i,r,o,e;return r=t.originalEvent,e=h(r.data),console.log("master",e),e===a?(u[r.origin].ready=!0,n):(o=e.id,(i=l[o])?i(e.args):n)},r.on("message",v),e=function(){function t(t,r){return this.origin=t,u[this.origin]?u[this.origin]:(this.id=c(),this.frame=i.createElement("iframe"),this.frame.id=this.id,this.frame.name=this.id,this.frame.src=this.origin+r,$("body").append($(this.frame).hide()),this.win=this.frame.contentWindow,u[this.origin]=this,this.ready=!1,n)}return t.prototype.send=function(t,i){var n=this;return this.check(function(){var r;return r=c(),d(r,function(t){return x(r),i(t)}),n.win.postMessage({id:r,payload:t},n.origin)})},t.prototype.check=function(t){var i,r,o,e=this;return this.ready?t():(i=0,r=3,o=setInterval(function(){if(e.ready)return clearInterval(o),t(),n;try{return e.win.postMessage(s,e.origin)}catch(a){if(i++>=r)throw clearInterval(o),"timeout";return console.log(""+a)}},500))},t}(),o=function(){function t(t,i){var n,r=this;if(this.ajaxOpts=t,null==i&&(i={}),!t)throw"ajax options required";if(!t.url)throw"url required";if(this.url=t.url,this.origin=m(this.url).origin,!this.origin)throw"invalid url";if(n=p[this.origin],!n)throw"missing origin: "+this.origin;this.opts=f(this.defaults,i),this.frame=new e(this.origin,n),this.d=$.Deferred(),this.frame.send(this.ajaxOpts,function(t){return r.d.resolve(t)}),this.d.promise()}return t.prototype.frames={},t.prototype.proxies={},t}(),$.xdomain=function(t){return $.extend(p,t)},$.xdomain.ajax=function(t,i){var n;return n=new o(t,i),n.d}}).call(this)})(window,document);