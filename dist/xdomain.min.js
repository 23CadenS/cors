// XDomain - v0.3.0 - https://github.com/jpillora/xdomain
// Â© Jaime Pillora <dev@jpillora.com> MIT 2013
!function(a,b,c){"use strict";var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(f=location.protocol+"//"+location.host,j=function(b){return a.console!==c?console.log("xdomain ("+f+"): "+b):void 0},x=["postMessage","JSON"],t=0,v=x.length;v>t;t++)if(g=x[t],!a[g])return j("requires '"+g+"' and this browser does not support it"),void 0;for(e="XPING",i=function(){return(Math.random()*Math.pow(2,32)).toString(16)},n=function(a){return/(https?:\/\/[^\/]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:null},l=function(c){return b.addEventListener?a.addEventListener("message",c):a.attachEvent("onmessage",c)},p=function(a){return JSON.stringify(a)},h=function(a){return JSON.parse(a)},r=function(b){return l(function(c){var d,e,f,g,i,k,l;return f=c.origin,(k=b[f]||b["*"])?(d=c.source,e=h(c.data),l=e.req,k&&k.test&&l&&(g=n(l.url),!k.test(g.path))?(j("blocked request to path: '"+g.path+"' by regex: "+k),void 0):(i=new XMLHttpRequest,i.open(l.method,l.url),i.onreadystatechange=function(){var b;if(4===i.readyState)return b=p({id:e.id,res:{props:i,responseHeaders:a.xhook.headers(i.getAllResponseHeaders())}}),d.postMessage(b,f)},i.send())):(j("blocked request from: '"+f+"'"),void 0)}),a.parent.postMessage(e,"*")},q=function(b){return l(function(a){var b;return null!=(b=d.prototype.frames[event.origin])?b.recieve(a):void 0}),a.xhook(function(a){return a.onCall("send",function(){var c,e;return e=n(a.url),e&&b[e.origin]?(c=new d(e.origin,b[e.origin]),c.send(a.serialize(),function(b){return a.deserialize(b),a.triggerComplete()}),!1):void 0})})},d=function(){function a(a,c){return this.origin=a,this.proxyPath=c,this.frames[this.origin]?this.frames[this.origin]:(this.frames[this.origin]=this,this.listeners={},this.frame=b.createElement("iframe"),this.frame.id=this.frame.name="xdomain-"+i(),this.frame.src=this.origin+this.proxyPath,this.frame.setAttribute("style","display:none;"),b.body.appendChild(this.frame),this.waits=0,this.ready=!1,void 0)}return a.prototype.frames={},a.prototype.post=function(a){return this.frame.contentWindow.postMessage(a,this.origin)},a.prototype.listen=function(a,b){if(this.listeners[a])throw"already listening for: "+a;return this.listeners[a]=b},a.prototype.unlisten=function(a){return delete this.listeners[a]},a.prototype.recieve=function(a){var b,c;return a.data===e?(this.ready=!0,void 0):(c=h(a.data),(b=this.listeners[c.id])?(this.unlisten(c.id),b(c.res)):(console.warn("missing id",c.id),void 0))},a.prototype.send=function(a,b){var c=this;return this.readyCheck(function(){var d;return d=i(),c.listen(d,function(a){return b(a)}),c.post(p({id:d,req:a}))})},a.prototype.readyCheck=function(a){var b=this;if(this.ready===!0)return a();if(this.waits++>=100)throw"Timeout connecting to iframe: "+this.origin;return setTimeout(function(){return b.readyCheck(a)},100)},a}(),a.xdomain=function(a){return a?(j("init"),a.masters&&r(a.masters),a.slaves?q(a.slaves):void 0):void 0},xdomain.origin=f,y=b.getElementsByTagName("script"),u=0,w=y.length;w>u;u++)if(o=y[u],/xdomain/.test(o.src)){if(o.hasAttribute("slave")){if(m=n(o.getAttribute("slave")),!m)return;s={},s[m.origin]=m.path,xdomain({slaves:s})}if(o.hasAttribute("master")){if(m=n(o.getAttribute("master")),!m)return;k={},k[m.origin]=/./,xdomain({masters:k})}}}(window,document);