/** XDomain - v0.0.1 - 2013/07/28
 * 
 * Copyright (c) 2013 Jaime Pillora - MIT
 */
(function(t,n,r){(function(){"use strict";var i,e,o,s,a,u,c,f,p,l,h,g,d,m,y,v,w,x,P;for(p=function(n){return t.console!==r?console.log("xdomain ("+location.origin+"): "+n):r},P=["postMessage","JSON"],w=0,x=P.length;x>w;w++)if(a=P[w],!t[a])return p("requires '"+a+"' and this browser does not support it"),r;i=$(t),d=$.ajax,o="__xdomain_PING",s="__xdomain_PONG",h={masters:{},slaves:{}},location.origin||(location.origin=location.protocol+"//"+location.host),c=function(){return(Math.random()*Math.pow(2,32)).toString(16)},g=function(t){var n;return n=t.match(/(https?:\/\/[^\/]+)(\/.*)/),n&&{origin:n[1],path:n[2]}},f=function(t,n){var r;return r=function(){},r.prototype=t,$.extend(!0,new r,n)},l=function(r){return n.addEventListener?t.addEventListener("message",r):t.attachEvent("onmessage",r)},m=function(t){return JSON.stringify(t)},u=function(t){return JSON.parse(t)},v=function(t){return l(function(n){var i,e;return(e=t[n.origin])?n.data===o?(n.source.postMessage(s,n.origin),r):(i=u(n.data),d(i.payload).always(function(){var t,r;return t=Array.prototype.slice.call(arguments),r=m({id:i.id,args:t}),n.source.postMessage(r,n.origin)})):(p("blocked message from: "+n.origin),r)})},y=function(t){return l(function(t){var n;return n=e.prototype.frames[event.origin],n?n.recieve(t):r}),$.ajax=function(n,i){var o,s,a;if(null==i&&(i={}),"string"==typeof n?i.url=n:(i=n,n=i.url),!n)throw"url required";return a=g(n),a&&t[a.origin]?(s=new e(a.origin,t[a.origin]),o=$.Deferred(),"function"==typeof i.success&&o.done(i.success),"function"==typeof i.error&&o.fail(i.error),"function"==typeof i.complete&&o.always(i.complete),s.send(i,function(t){return"success"===t[1]?o.resolve.apply(o,t):"error"===t[1]?o.reject.apply(o,t):r}),o.promise()):d.call($,n,i)}},e=function(){function t(t,i){var e=this;return this.origin=t,this.proxyPath=i,this.frames[this.origin]?this.frames[this.origin]:(this.frames[this.origin]=this,this.listeners={},this.frame=n.createElement("iframe"),this.frame.id=this.frame.name="xdomain-"+c(),this.frame.src=this.origin+this.proxyPath,$(function(){return $("body").append($(e.frame).hide())}),this.pingPong.attempts=0,this.ready=!1,r)}return t.prototype.frames={},t.prototype.post=function(t){return this.frame.contentWindow.postMessage(t,this.origin)},t.prototype.listen=function(t,n){if(this.listeners[t])throw"already listening for: "+t;return this.listeners[t]=n},t.prototype.unlisten=function(t){return delete this.listeners[t]},t.prototype.recieve=function(t){var n,i;return t.data===s?(this.ready=!0,r):(i=u(t.data),(n=this.listeners[i.id])?(this.unlisten(i.id),n(i.args)):(console.warn("missing id",i.id),r))},t.prototype.send=function(t,n){var r=this;return this.pingPong(function(){var i;return i=c(),r.listen(i,function(t){return n(t)}),r.post(m({id:i,payload:t}))})},t.prototype.pingPong=function(t){var n,r=this;if(this.ready===!0)return t();if((null!=(n=this.frame)?n.contentWindow:void 0)&&this.post(o),this.pingPong.attempts++>=10)throw"Timeout connecting to iframe: "+this.origin;return setTimeout(function(){return r.pingPong(t)},500)},t}(),$.xdomain=function(t){return t?(t.masters&&v(t.masters),t.slaves?y(t.slaves):r):r}}).call(this)})(window,document);