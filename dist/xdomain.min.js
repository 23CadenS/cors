/** XDomain - v0.0.1 - 2013/04/10
 * 
 * Copyright (c) 2013 Jaime Pillora - MIT
 */
(function(t,i,n){(function(){"use strict";var r,e,o,s,a,u,c,h,l,d,f,g,p,m,v,y,w,x,M;g=function(i){return console&&console.log?console.log("xdomain",t.location.host,": ",i):n},g("init client"),x=t.top!==t,r=$(t),v=$.ajax,s="__xdomain_PING",a="__xdomain_PONG",p={masters:{},slaves:{}},u={},f={},d=function(t,i){if(f[t])throw"already listening for: "+t;return f[t]=i},M=function(t){return delete f[t]},h=function(){return(Math.random()*Math.pow(2,32)).toString(16)},m=function(t){var i;return i=t.match(/(https?:\/\/[^\/]+)(\/.*)/),i&&{origin:i[1],path:i[2]}},l=function(t,i){var n;return n=function(){},n.prototype=t,$.extend(!0,new n,i)},w=function(t){return JSON.stringify(t)},c=function(t){return JSON.parse(t)},y=x?function(t){var i,r,e,o;if(i=t.originalEvent,console.log("slave",i.data),e=i.origin,i.data===s)return i.source.postMessage(a,e),n;if(r=c(i.data),o=p.masters[e],!o)throw"Origin not allowed: "+e;return v(r.payload).always(function(){var t,n;return t=Array.prototype.slice.call(arguments),n=w({id:r.id,args:t}),i.source.postMessage(n,i.origin)})}:function(t){var i,r,e;return r=t.originalEvent,console.log("master",r.data),r.data===a?(u[r.origin].ready=!0,n):(e=c(r.data),i=f[e.id],i?i(e.args):(console.warn("missing id",e.id),n))},r.on("message",y),o=function(){function t(t,r){return this.origin=t,u[this.origin]?u[this.origin]:(this.id=h(),this.frame=i.createElement("iframe"),this.frame.id=this.id,this.frame.name=this.id,this.frame.src=this.origin+r,$("body").append($(this.frame).hide()),this.win=this.frame.contentWindow,u[this.origin]=this,this.ready=!1,n)}return t.prototype.send=function(t,i){var n=this;return this.check(function(){var r;return r=h(),d(r,function(t){return M(r),i(t)}),n.win.postMessage(w({id:r,payload:t}),n.origin)})},t.prototype.check=function(t){var i,r,e,o=this;return this.ready?t():(i=0,r=3,e=setInterval(function(){if(o.ready)return clearInterval(e),t(),n;try{return o.win.postMessage(s,o.origin)}catch(a){if(i++>=r)throw clearInterval(e),"timeout";return console.log(""+a)}},500))},t}(),e=function(){function t(t,i,n){var r;if(this.origin=t,this.url=i,this.opts=n,r=p.slaves[this.origin],!r)throw"Missing slave origin: "+this.origin;this.frame=new o(this.origin,r),this.d=$.Deferred(),this.frame.send(this.opts,$.proxy(this.handleResponse,this)),this.d.promise()}return t.prototype.handleResponse=function(t){return"success"===t[1]?this.d.resolve.apply(this.d,t):"error"===t[1]?this.d.reject.apply(this.d,t):n},t}(),$.xdomain=function(t){return $.extend(p,t)},$.ajax=function(t,i){var n,r;if(null==i&&(i={}),"string"==typeof t?i.url=t:(i=t,t=i.url),!t)throw"url required";return console.log("$.ajax",t),r=m(t),r&&r.origin?(n=new e(r.origin,t,i),n.d):v.call($,t,i)}}).call(this)})(window,document);